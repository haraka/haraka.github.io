import{u as R,b as _,g as k}from"./index.54cc9473.js";import{d as N}from"./DocsAsideTree.7701d631.js";import{r as T}from"./asyncData.10a69bdc.js";import{u as x,h as C}from"./Container.19d24615.js";import{u as f}from"./cookie.909cd8cc.js";import O from"./ContentPreviewMode.ef3dad42.js";import{i as U,j as b,k as L,S as A,m as y}from"./entry.8b16ad33.js";import{e as J}from"./runtime-core.esm-bundler.dee127ca.js";/* empty css                               */import"./query.c3f7607a.js";const F=(u,m,g)=>{const v=[...m||[]],r=[...g||[]],p=[...u||[]];for(const i of v)if(i.oldPath)if(r.splice(r.findIndex(a=>a.path===i.oldPath),1),v.find(a=>a.path===i.oldPath))p.push({path:i.path,parsed:i.parsed});else{const a=p.find(l=>l.path===i.oldPath);a&&(a.path=i.path,i.parsed?a.parsed=i.parsed:i.pathMeta&&["_file","_path","_id","_locale"].forEach(l=>{a.parsed[l]=i.pathMeta[l]}))}else if(i.new)p.push({path:i.path,parsed:i.parsed});else{const d=p.find(a=>a.path===i.path);d&&Object.assign(d,{path:i.path,parsed:i.parsed})}for(const i of r)p.splice(p.findIndex(d=>d.path===i.path),1);return p},j=U(()=>JSON.parse(JSON.stringify(C()))),Q=()=>{const u=R(),m=_().public.studio||{},g=j();let v;const r=x("client-db",()=>null),p=async(e,t,s=!0)=>{const n=f("previewToken",{sameSite:"none",secure:!0}),c=await e.getKeys(`${n.value}:`);await Promise.all(c.map(o=>e.removeItem(o))),await e.setItem(`${n.value}$`,JSON.stringify({ignoreBuiltContents:s})),await Promise.all(t.map(o=>{var h;return e.setItem(`${n.value}:${(h=o.parsed)==null?void 0:h._id}`,JSON.stringify(o.parsed))}))},i=e=>{const t=k(u,C);b(t,e||g),L(t,e||g)},d=e=>{var s,n,c,o;const t=(o=(c=(n=(s=u==null?void 0:u.vueApp)==null?void 0:s._context)==null?void 0:n.config)==null?void 0:c.globalProperties)==null?void 0:o.$pinceauTheme;!t||!(t!=null&&t.updateTheme)||(v||(v=JSON.parse(JSON.stringify((t==null?void 0:t.theme.value)||{}))),k(u,t.updateTheme,[e||v]))},a=async e=>{const t=f("previewToken",{sameSite:"none",secure:!0}),s=await $fetch("api/projects/preview",{baseURL:m.apiURL,params:{token:t.value}}),n=F(s.files,s.additions,s.deletions),c=n.filter(w=>!w.path.startsWith(A));await p(e,c,(s.files||[]).length!==0);const o=n.find(w=>w.path===y.appConfig);i(o==null?void 0:o.parsed);const h=n.find(w=>w.path===y.tokensConfig);d(h==null?void 0:h.parsed)},l=async()=>{const e=f("previewToken",{sameSite:"none",secure:!0});await $fetch("api/projects/preview/sync",{baseURL:m.apiURL,method:"POST",params:{token:e.value}})},P=e=>{const t=f("previewToken",{sameSite:"none",secure:!0}),s=J(()=>!!e.value),n=document.createElement("div");n.id="__nuxt_preview_wrapper",document.body.appendChild(n),N(O,{previewToken:t,apiURL:m.apiURL,storageReady:s,refresh:()=>a(e.value).then(()=>T()),init:l}).mount(n)},S=async e=>{var n,c;const t=f("previewToken",{sameSite:"none",secure:!0});if(!e)return null;e=e.replace(/\/$/,"");let s=await((n=r.value)==null?void 0:n.getItem(`${t.value}:${e}`));return s||(s=await((c=r.value)==null?void 0:c.getItem(e))),s},$=e=>{var s;const t=f("previewToken",{sameSite:"none",secure:!0});r.value&&r.value.setItem(`${t.value}:${(s=e.parsed)==null?void 0:s._id}`,JSON.stringify(e.parsed))},I=async e=>{var s;const t=f("previewToken",{sameSite:"none",secure:!0});await((s=r.value)==null?void 0:s.removeItem(`${t.value}:${e}`))};return{apiURL:m.apiURL,contentStorage:r,syncPreview:a,syncPreviewFiles:p,syncPreviewAppConfig:i,syncPreviewTokensConfig:d,requestPreviewSynchronization:l,mountPreviewUI:P,findContentWithId:S,updateContent:$,removeContentWithId:I,requestRerender:()=>{k(u,T)}}};export{Q as useStudio};
