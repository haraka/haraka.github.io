{"_path":"/plugins/relay","_dir":"plugins","_draft":false,"_partial":false,"_locale":"","title":"relay - Relay outbound mail","description":"Haraka relay plugin - Relay outbound mail","navigation":{"title":"relay"},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"relay-plugin"},"children":[{"type":"text","value":"relay plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://en.wikipedia.org/wiki/Mail_transfer_agent","rel":["nofollow"]},"children":[{"type":"text","value":"MTAs"}]},{"type":"text","value":" generally only accept mail for "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"local"}]},{"type":"text","value":" domains they can deliver to. In Haraka, the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"rcpt_to.*"}]},{"type":"text","value":" plugins usually decide which domains and/or email addresses are deliverable. By default, everything else is rejected."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Relaying"}]},{"type":"text","value":" is when a MTA accepts mail that is destined elsewhere. Back in the day (1980s), most MTAs permitted open relaying. Soon spammers abused our open relays (1990s) and left us with soiled mail queues. Now nearly all MTAs have relaying disabled and "},{"type":"element","tag":"a","props":{"href":"http://en.wikipedia.org/wiki/Mail_user_agent","rel":["nofollow"]},"children":[{"type":"text","value":"MUAs"}]},{"type":"text","value":" are required to use a "},{"type":"element","tag":"a","props":{"href":"http://en.wikipedia.org/wiki/Message_submission_agent","rel":["nofollow"]},"children":[{"type":"text","value":"MSA"}]},{"type":"text","value":" to relay. Most MTAs (including Haraka) have MSA features and can serve both purposes."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"relay"}]},{"type":"text","value":" plugin provides Haraka with options for managing relay permissions."}]},{"type":"element","tag":"h2","props":{"id":"authentication"},"children":[{"type":"text","value":"Authentication"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One way to enable relaying is "},{"type":"element","tag":"a","props":{"href":"/core/Plugins"},"children":[{"type":"text","value":"authentication"}]},{"type":"text","value":" via the auth plugins. Successful authentication enables relaying during "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"that"}]},{"type":"text","value":" SMTP connection. To securely offer SMTP AUTH, the "},{"type":"element","tag":"a","props":{"href":"/plugins/tls"},"children":[{"type":"text","value":"tls"}]},{"type":"text","value":" plugin and at least one auth plugin must be enabled and properly configured. When that requirement is met, the AUTH SMTP extension will be advertised to SMTP clients."}]},{"type":"element","tag":"pre","props":{"code":"% nc mail.example.com 587\n220 mail.example.com ESMTP Haraka 2.4.0 ready\nehlo client.example.com\n250-mail.example.com Hello client.example.com [192.168.0.1], Haraka is at your service.\n250-PIPELINING\n250-8BITMIME\n250-SIZE 10000000\n250 STARTTLS\nquit\n221 mail.example.com closing connection. Have a jolly good day.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"% nc mail.example.com 587\n220 mail.example.com ESMTP Haraka 2.4.0 ready\nehlo client.example.com\n250-mail.example.com Hello client.example.com [192.168.0.1], Haraka is at your service.\n250-PIPELINING\n250-8BITMIME\n250-SIZE 10000000\n250 STARTTLS\nquit\n221 mail.example.com closing connection. Have a jolly good day.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Notice that there's no AUTH advertised. We only permit authentication when the\nconnection is secured with TLS:"}]},{"type":"element","tag":"pre","props":{"code":"% openssl s_client -connect mail.example.com:587 -starttls smtp\nCONNECTED(00000003)\n<snip long SSL certificate details>\n---\n250 STARTTLS\nehlo client.example.com\n250-mail.example.com Hello client.example.com [192.168.1.1], Haraka is at your service.\n250-PIPELINING\n250-8BITMIME\n250-SIZE 10000000\n250 AUTH PLAIN LOGIN\nquit\n221 mail.example.com closing connection. Have a jolly good day.\nclosed\n","language":"text","meta":"","className":"language-text shiki shiki-themes github-dark github-light","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"% openssl s_client -connect mail.example.com:587 -starttls smtp\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"CONNECTED(00000003)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"<snip long SSL certificate details>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"---\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"250 STARTTLS\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"ehlo client.example.com\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"250-mail.example.com Hello client.example.com [192.168.1.1], Haraka is at your service.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"250-PIPELINING\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"250-8BITMIME\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"250-SIZE 10000000\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"250 AUTH PLAIN LOGIN\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"quit\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"221 mail.example.com closing connection. Have a jolly good day.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"closed\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To avoid port 25 restrictions, in 1998 we developed "},{"type":"element","tag":"a","props":{"href":"http://tools.ietf.org/html/rfc2476","rel":["nofollow"]},"children":[{"type":"text","value":"SMTP submission"}]},{"type":"text","value":" on port 587. As of January 2018, "},{"type":"element","tag":"a","props":{"href":"https://tools.ietf.org/html/rfc8314","rel":["nofollow"]},"children":[{"type":"text","value":"RFC 8314"}]},{"type":"text","value":" resurrects "},{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/SMTPS","rel":["nofollow"]},"children":[{"type":"text","value":"SMTPS"}]},{"type":"text","value":" on port 465 in favor of port 587 with STARTTLS. For optimal security and reliability, "},{"type":"element","tag":"a","props":{"href":"http://en.wikipedia.org/wiki/Mail_user_agent","rel":["nofollow"]},"children":[{"type":"text","value":"MUAs"}]},{"type":"text","value":" should be configured to send mail to port 465 with TLS."}]},{"type":"element","tag":"h2","props":{"id":"acl-access-control-list"},"children":[{"type":"text","value":"ACL (Access Control List)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ACL processing is enabled by setting acl=true in the "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"relay"}]},{"type":"text","value":" section of\nrelay.ini:"}]},{"type":"element","tag":"pre","props":{"code":"[relay]\nacl=true\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[relay]\nacl=true\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"With the Access Control List feature, relaying can be enabled for IPv4 and\nIPv6 networks. IP ranges listed in the ACL file are allowed to send mails\nwithout furthur checks."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"config/relay_acl_allow"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Allowed IP ranges in CIDR notation, one per line."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Back in the day, ISPs enabled all of their IP space to relay. That proved\nproblematic for users who took their laptops and mobile phones elsewhere and\nthen couldn't send mail. For end users therefore, use SMTP AUTH described\nabove. If you reside somewhere technology evolves more slowly, you can still\nadd IP allocations to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"relay_acl_allow"}]},{"type":"text","value":" like so:"}]},{"type":"element","tag":"pre","props":{"code":"echo 'N.N.N.N/24' >> /path/to/haraka/config/relay_acl_allow\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"echo 'N.N.N.N/24' >> /path/to/haraka/config/relay_acl_allow\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A common use case for IP based relaying is to relay messages on behalf of\nanother mail server. If your organization has an Exchange server, using Haraka\nto filter inbound messages is a great choice. You might also want to relay\noutbound messages via Haraka as well, so they can be DKIM signed on their way\nto the internet. For such a use case, you would set 'acl=true' (the default)\nin the "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"relay"}]},{"type":"text","value":" section of "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"relay.ini"}]},{"type":"text","value":" and then add the external IP address\nof the corporate firewall to "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"config/relay_acl_allow"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"echo 'N.N.N.N/32' >> /path/to/haraka/config/relay_acl_allow\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"echo 'N.N.N.N/32' >> /path/to/haraka/config/relay_acl_allow\n"}]}]},{"type":"element","tag":"h2","props":{"id":"force-route-destination-domains"},"children":[{"type":"text","value":"Force Route / Dest"},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"ination"}]},{"type":"text","value":" Domains"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Force routes and Destination Domains are enabled by setting in the "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"relay"}]},{"type":"text","value":"\nsection of relay.ini:"}]},{"type":"element","tag":"pre","props":{"code":"[relay]\nforce_routing=false  (default: false)\ndest_domains=false   (default: false)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[relay]\nforce_routing=false  (default: false)\ndest_domains=false   (default: false)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These two features share another common config file:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"config/relay_dest_domains.ini"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The format is ini and entries are within the "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"domains"}]},{"type":"text","value":" section. The key for each entry is the domain and the value is a JSON string. Within the JSON string, the currently supported keys are:"}]},{"type":"element","tag":"pre","props":{"code":"* action  (Dest Domains)\n* nexthop (Force Route)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"* action  (Dest Domains)\n* nexthop (Force Route)\n"}]}]},{"type":"element","tag":"h3","props":{"id":"force-route"},"children":[{"type":"text","value":"Force Route"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Think of force route as the equivalent of the transport map in Postfix or the smtproutes file in Qmail. Rather than looking up the MX for a host, the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"nexthop"}]},{"type":"text","value":" value from the entry in the config file is used."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The value of \"nexthop\": can be a hostname or an IP, optionally follow by "},{"type":"element","tag":"port","props":{},"children":[]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Example:"}]},{"type":"element","tag":"pre","props":{"code":"[domains]\ntest.com = { \"action\": \"continue\", \"nexthop\": \"127.0.0.1:2525\" }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[domains]\ntest.com = { \"action\": \"continue\", \"nexthop\": \"127.0.0.1:2525\" }\n"}]}]},{"type":"element","tag":"h3","props":{"id":"destination-domains"},"children":[{"type":"text","value":"Destination Domains"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Allowed destination/recipient domains. The field within the JSON value used\nby Dest Domains is \"action\": and the possible values are accept, continue, or\ndeny."}]},{"type":"element","tag":"pre","props":{"code":"* accept   (accept the mail without further checks)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"* accept   (accept the mail without further checks)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Example:"}]},{"type":"element","tag":"pre","props":{"code":"[domains]\ntest.com = { \"action\": \"accept\" }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[domains]\ntest.com = { \"action\": \"accept\" }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I think of "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"accept"}]},{"type":"text","value":" as the equivalent of qmail's "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"rcpthosts"}]},{"type":"text","value":", or a misplaced Haraka "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"rcpt_to.*"}]},{"type":"text","value":" plugin. The "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"accept"}]},{"type":"text","value":" mechanism is another way to tell Haraka that a particular domain is one we accept mail for. The difference between this and the "},{"type":"element","tag":"a","props":{"href":"/plugins/rcpt_to.in_host_list"},"children":[{"type":"text","value":"rcpt_to.in_host_list"}]},{"type":"text","value":" plugin is that this one also enables relaying."}]},{"type":"element","tag":"pre","props":{"code":"* continue (mails are subject to further checks)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"* continue (mails are subject to further checks)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Example:"}]},{"type":"element","tag":"pre","props":{"code":"[domains]\ntest.com = { \"action\": \"continue\" }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[domains]\ntest.com = { \"action\": \"continue\" }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Because the default behavior of Dest Routes is to deny, the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"continue"}]},{"type":"text","value":" option provides an escape, permitting another Haraka plugin to validate the recipient. Like the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"accept"}]},{"type":"text","value":" option, it too enables relaying."}]},{"type":"element","tag":"pre","props":{"code":"* deny    (mails are rejected)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"* deny    (mails are rejected)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This deny option baffles me. The default behavior of Haraka is to reject emails for\nwhich a recipient validation plugin hasn't vouched. Adding it here prevents\nany subsequent recipient validation plugin from getting a chance. It also\nnecessitates the continue option."}]},{"type":"element","tag":"h2","props":{"id":"all"},"children":[{"type":"text","value":"all"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Relay all is enabled by setting all=true in the "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"relay"}]},{"type":"text","value":" section of\nrelay.ini:"}]},{"type":"element","tag":"pre","props":{"code":"[relay]\nall=true     (default: false)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[relay]\nall=true     (default: false)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Relay all is useful for spamtraps to accept all mail."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Do NOT use this on a real mail server, unless you really know what you are\ndoing. If you use the all feature with anything that relays mail (such\nas forwarding to a real mail server, or the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deliver"}]},{"type":"text","value":" plugin), your mail\nserver is now an open relay."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is BAD. Hence the big letters. In short: DO NOT USE THIS FEATURE."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It is useful for testing and spamtraps, hence its presence."}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"authentication","depth":2,"text":"Authentication"},{"id":"acl-access-control-list","depth":2,"text":"ACL (Access Control List)"},{"id":"force-route-destination-domains","depth":2,"text":"Force Route / Destination Domains","children":[{"id":"force-route","depth":3,"text":"Force Route"},{"id":"destination-domains","depth":3,"text":"Destination Domains"}]},{"id":"all","depth":2,"text":"all"}]}},"_type":"markdown","_id":"content:8.plugins:relay.md","_source":"content","_file":"8.plugins/relay.md","_stem":"8.plugins/relay","_extension":"md"}