[{"_path":"/core/Net_Utils","_dir":"core","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Net_Utils","description":"This module provides network utility functions.","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"net_utils"},"children":[{"type":"text","value":"Net_Utils"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This module provides network utility functions."}]},{"type":"element","tag":"h2","props":{"id":"usage"},"children":[{"type":"text","value":"Usage"}]},{"type":"element","tag":"code","props":{"code":"var net_utils = require('./net_utils');\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"var net_utils = require('./net_utils');\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"ip_to_long"},"children":[{"type":"text","value":"ip_to_long"}]},{"type":"element","tag":"code","props":{"code":"// Convert IPv4 to long\nvar long = net_utils.ip_to_long('11.22.33.44');  // 185999660\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Convert IPv4 to long\nvar long = net_utils.ip_to_long('11.22.33.44');  // 185999660\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"long_to_ip"},"children":[{"type":"text","value":"long_to_ip"}]},{"type":"element","tag":"code","props":{"code":"// Convert long to IPv4\nvar ip = net_utils.long_to_ip(185999660);  // 11.22.33.44\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Convert long to IPv4\nvar ip = net_utils.long_to_ip(185999660);  // 11.22.33.44\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"dec_to_hex"},"children":[{"type":"text","value":"dec_to_hex"}]},{"type":"element","tag":"code","props":{"code":"// Convert decimal to hex\nvar hex = net_utils.dec_to_hex(20111104);  // 132df00\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Convert decimal to hex\nvar hex = net_utils.dec_to_hex(20111104);  // 132df00\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"hex_to_dec"},"children":[{"type":"text","value":"hex_to_dec"}]},{"type":"element","tag":"code","props":{"code":"// Convert hex to decimal\nvar dec = net_utils.hex_to_dec('132df00');  // 20111104\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Convert hex to decimal\nvar dec = net_utils.hex_to_dec('132df00');  // 20111104\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"is_local_ipv4"},"children":[{"type":"text","value":"is_local_ipv4"}]},{"type":"element","tag":"code","props":{"code":"// Is IPv4 address on a local network?\nnet_utils.is_local_ipv4('127.0.0.200');   // true (localhost)\nnet_utils.is_local_ipv4('169.254.0.0');   // true (link local)\nnet_utils.is_local_ipv4('226.0.0.1');     // false\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Is IPv4 address on a local network?\nnet_utils.is_local_ipv4('127.0.0.200');   // true (localhost)\nnet_utils.is_local_ipv4('169.254.0.0');   // true (link local)\nnet_utils.is_local_ipv4('226.0.0.1');     // false\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"is_private_ipv4"},"children":[{"type":"text","value":"is_private_ipv4"}]},{"type":"element","tag":"code","props":{"code":"// Is IPv4 address in RFC 1918 reserved private address space?\nnet_utils.is_private_ipv4('10.0.0.0');       // true\nnet_utils.is_private_ipv4('192.168.0.0');    // true\nnet_utils.is_private_ipv4('172.16.0.0');     // true\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Is IPv4 address in RFC 1918 reserved private address space?\nnet_utils.is_private_ipv4('10.0.0.0');       // true\nnet_utils.is_private_ipv4('192.168.0.0');    // true\nnet_utils.is_private_ipv4('172.16.0.0');     // true\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"is_local_ipv6"},"children":[{"type":"text","value":"is_local_ipv6"}]},{"type":"element","tag":"code","props":{"code":"// Is IPv6 addr on local network?\nnet_utils.is_local_ipv6('::1');           // true (localhost)\nnet_utils.is_local_ipv6('fe80::')         // true (link local)\nnet_utils.is_local_ipv6('fc00::')         // true (unique local)\nnet_utils.is_local_ipv6('fd00::')         // true (unique local)\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// Is IPv6 addr on local network?\nnet_utils.is_local_ipv6('::1');           // true (localhost)\nnet_utils.is_local_ipv6('fe80::')         // true (link local)\nnet_utils.is_local_ipv6('fc00::')         // true (unique local)\nnet_utils.is_local_ipv6('fd00::')         // true (unique local)\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"is_private_ip"},"children":[{"type":"text","value":"is_private_ip"}]},{"type":"element","tag":"code","props":{"code":"// determines if an IPv4 or IPv6 address is on a \"private\" network\n// For IPv4, returns true if is_private_ipv4 or is_local_ipv4 are true\n// For IPv6, returns true if is_local_ipv6 is true\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// determines if an IPv4 or IPv6 address is on a \"private\" network\n// For IPv4, returns true if is_private_ipv4 or is_local_ipv4 are true\n// For IPv6, returns true if is_local_ipv6 is true\n"}]}]}]}]},"_type":"markdown","_id":"content:6.core:10.Net_Utils.md","_source":"content","_file":"6.core/10.Net_Utils.md","_extension":"md"},{"_path":"/core/Outbound","_dir":"core","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Outbound Mail with Haraka","description":"How to send outbound mail with Haraka","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"outbound-mail"},"children":[{"type":"text","value":"Outbound Mail"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A default installation of Haraka will queue outbound mail for delivery in the\nqueue directory. Those mails will be delivered to the appropriate MX record\nfor that domain. Mails are queued onto your disk, and will deal appropriately\nwith temporary failures to retry delivery later."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Outbound mails are defined as those that have set the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connection.relaying"}]},{"type":"text","value":"\nflag to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"true"}]},{"type":"text","value":" via a plugin. The simplest way of doing that is to use SMTP\nAUTH, and have the client authenticate. For example using the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"auth/flat_file"}]},{"type":"text","value":"\nplugin. However it is very simple to write a custom plugin to do this."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For statistics on outbound mail use the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"process_title"}]},{"type":"text","value":" plugin. See the\ndocumentation for that plugin for details."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To flush the outbound queue (for temporary failed mails) hit the Haraka master\nprocess with the SIGHUP signal (via the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"kill"}]},{"type":"text","value":" command line tool)."}]},{"type":"element","tag":"h2","props":{"id":"outbound-configuration-files"},"children":[{"type":"text","value":"Outbound Configuration Files"}]},{"type":"element","tag":"h3","props":{"id":"outboundini"},"children":[{"type":"text","value":"outbound.ini"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"disabled"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Default: false. Allows one to temporarily disable outbound delivery, while\nstill receiving and queuing emails. This can be changed while Haraka is\nrunning."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"concurrency_max"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Default: 100. Specifies the maximum concurrent connections to make. Note that\nif using cluster (multiple CPUs) then this will be multiplied by the number\nof CPUs that you have."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"enable_tls"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Default: true. Switch to false to disable TLS for outbound mail."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This uses the same "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"tls_key.pem"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"tls_cert.pem"}]},{"type":"text","value":" files that the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"tls"}]},{"type":"text","value":"\nplugin uses, along with other values in "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"tls.ini"}]},{"type":"text","value":". See the "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/manual/plugins/tls.html","rel":["nofollow"]},"children":[{"type":"text","value":"tls plugin\ndocs"}]},{"type":"text","value":" for information on generating those\nfiles."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Within "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"tls.ini"}]},{"type":"text","value":" you can specify global options for the values "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"ciphers"}]},{"type":"text","value":",\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"requestCert"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"rejectUnauthorized"}]},{"type":"text","value":", alternatively you can provide\nseparate values by putting them under a key: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"[outbound]"}]},{"type":"text","value":", such as:"}]},{"type":"element","tag":"code","props":{"code":"[outbound]\nciphers=!DES\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[outbound]\nciphers=!DES\n"}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"ipv6_enabled"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When this has a \"true\" value inside (usually a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"), it defaults to an 'AAAA'\nlookup first for each MX record, and uses those hosts to send email via."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"always_split"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Default: false. By default, Haraka groups message recipients by domain so that\nmessages with multiple recipients at the same domain get sent in a single SMTP\nsession. When "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"always_split"}]},{"type":"text","value":" is enabled, each recipient gets a queue entry and\ndelivery in its own SMTP session. This carries a performance penalty but\nenables more flexibility in mail delivery and bounce handling."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"received_header"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Default: \"Haraka outbound\". If this text is any string except "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"disabled"}]},{"type":"text","value":", the\nstring is attached as a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Received"}]},{"type":"text","value":" header to all outbound mail just before it is queued."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connect_timeout"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Timeout for connecting to remote servers. Default: 30s"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"pool_timeout"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Outbound mail uses \"pooled\" connections. An unused pool connection will send\na QUIT after this time. Default: 50s"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Pooled connections means that a mail to a particular IP address will hold that\nconnection open and use it the next time it is requested. This helps with\nlarge scale outbound mail. If you don't send lots of mail it is advised to\nlower the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"pool_timeout"}]},{"type":"text","value":" value since it may upset receiving mail servers."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Setting this value to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"0"}]},{"type":"text","value":" will effectively disable the use of pools. You may\nwish to set this if you have a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"get_mx"}]},{"type":"text","value":" hook that picks outbound servers on\na per-email basis (rather than per-domain)."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"pool_concurrency_max"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Set this to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"0"}]},{"type":"text","value":" to completely disable the pooling code."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This value determines how many concurrent connections can be made to a single\nIP address (destination) in the pool. Default: 10 connections."}]},{"type":"element","tag":"h3","props":{"id":"outboundbounce_message"},"children":[{"type":"text","value":"outbound.bounce_message"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"See \"Bounce Messages\" below for details."}]},{"type":"element","tag":"h2","props":{"id":"the-hmail-object"},"children":[{"type":"text","value":"The HMail Object"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Many hooks (see below) pass in a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"hmail"}]},{"type":"text","value":" object."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You likely won't ever need to call methods on this object, so they are left\nundocumented here."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The attributes of an "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"hmail"}]},{"type":"text","value":" object that may be of use are:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"path - the full path to the queue file"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"filename - the filename within the queue dir"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"num_failures - the number of times this mail has been temp failed"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"notes - notes you can store on a hmail object (similar to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"transaction.notes"}]},{"type":"text","value":")\nto allow you to pass information between outbound hooks"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"todo - see below"}]}]},{"type":"element","tag":"h2","props":{"id":"the-todo-object"},"children":[{"type":"text","value":"The ToDo Object"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"todo"}]},{"type":"text","value":" object contains information about how to deliver this mail. Keys\nyou may be interested in are:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"rcpt_to - an Array of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Address"}]},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":" objects - the rfc.2821 recipients of this mail"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"mail_from - an "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Address"}]},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":" object - the rfc.2821 sender of this mail"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"domain - the domain this mail is going to (see "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"always_split"}]},{"type":"text","value":" above)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"notes - the original transaction.notes for this mail, also contains the\nfollowing useful keys:\n** outbound_ip - the IP address to bind to (note do not set this manually,\nuse the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"get_mx"}]},{"type":"text","value":" hook)\n** outbound_helo - the EHLO domain to use (again, do not set manually)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"queue_time - the epoch milliseconds time when this mail was queued"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"uuid - the original transaction.uuid"}]}]},{"type":"element","tag":"h2","props":{"id":"outbound-mail-hooks"},"children":[{"type":"text","value":"Outbound Mail Hooks"}]},{"type":"element","tag":"h3","props":{"id":"the-queue_outbound-hook"},"children":[{"type":"text","value":"The queue_outbound hook"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The first hook that is called prior to queueing an outbound mail is the\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"queue_outbound"}]},{"type":"text","value":" hook. Only if all these hooks return "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"CONT"}]},{"type":"text","value":" (or if there are\nno hooks) will the mail be queued for outbound delivery. A return of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"OK"}]},{"type":"text","value":" will\nindicate that the mail has been queued in some custom manner for outbound\ndelivery. Any of the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"DENY"}]},{"type":"text","value":" return codes will cause the message to be\nappropriately rejected."}]},{"type":"element","tag":"h3","props":{"id":"the-send_email-hook"},"children":[{"type":"text","value":"The send_email hook"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parameters: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next, hmail"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Called just as the email is about to be sent."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Respond with "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(DELAY, delay_seconds)"}]},{"type":"text","value":" to defer sending the email at this time."}]},{"type":"element","tag":"h3","props":{"id":"the-get_mx-hook"},"children":[{"type":"text","value":"The get_mx hook"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parameters: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next, hmail, domain"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Upon starting delivery the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"get_mx"}]},{"type":"text","value":" hook is called, with the parameter set to\nthe domain in question (for example a mail to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"user@example.com"}]},{"type":"text","value":" will call the\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"get_mx"}]},{"type":"text","value":" hook with "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"(next, hmail, domain)"}]},{"type":"text","value":" as parameters). This is to allow\nyou to implement a custom handler to find MX records. For most installations\nthere is no reason to implement this hook - Haraka will find the correct MX\nrecords for you."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The MX record is sent via next(OK, mx) and can be one of:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A string of one of the following formats:"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hostname"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hostname:port"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ipaddress"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ipaddress:port"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"An MX object of the form: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"{priority: 0, exchange: hostname}"}]},{"type":"text","value":" with the\nfollowing optional properies:\n* "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"port"}]},{"type":"text","value":" to specify an alternate port\n* "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"bind"}]},{"type":"text","value":" to specify an outbound IP address to bind to\n* "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"bind_helo"}]},{"type":"text","value":" to specify an outbound helo for IP address to bind to\n* "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"using_lmtp"}]},{"type":"text","value":" boolean to specify that delivery should be attempted using\nLMTP instead of SMTP.\n*  "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"auth_user"}]},{"type":"text","value":" to specify an AUTH username (required if AUTH is desired)\n*  "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"auth_pass"}]},{"type":"text","value":" to specify an AUTH password (required if AUTH is desired)\n*  "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"auth_type"}]},{"type":"text","value":" to specify an AUTH type that should be used with the MX.\nIf this is not specified then Haraka will pick an appropriate method."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A list of MX objects in an array, each in the same format as above."}]}]},{"type":"element","tag":"h3","props":{"id":"the-deferred-hook"},"children":[{"type":"text","value":"The deferred hook"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parameters: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next, hmail, {delay: ..., err: ...}"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If the mail is temporarily deferred, the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"deferred"}]},{"type":"text","value":" hook is called. The hook\nparameter is an object with keys: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"delay"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"err"}]},{"type":"text","value":", which explain the delay\n(in seconds) and error message."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you want to stop at this point, and drop the mail completely, then you\ncan call "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(OK)"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you want to change the delay, then call "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(DENYSOFT, delay_in_seconds)"}]},{"type":"text","value":".\nUsing this you can define a custom delay algorithm indexed by\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"hmail.num_failures"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"the-bounce-hook"},"children":[{"type":"text","value":"The bounce hook"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parameters: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next, hmail, error"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If the mail completely bounces then the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"bounce"}]},{"type":"text","value":" hook is called. This is "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"not"}]},{"type":"text","value":"\ncalled if the mail is issued a temporary failure (a 4xx error code). The hook\nparameter is the error message received from the remote end as an "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Error"}]},{"type":"text","value":" object.\nThe object may also have the following properties:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"mx - the MX object that caused the bounce"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"deferred_rcpt - the deferred recipients that eventually bounced"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"bounced_rcpt - the bounced recipients"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you do not wish to have a bounce message sent to the originating sender of the\nemail then you can return "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"OK"}]},{"type":"text","value":" from this hook to stop it from sending a bounce message."}]},{"type":"element","tag":"h3","props":{"id":"the-delivered-hook"},"children":[{"type":"text","value":"The delivered hook"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Parameters: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next, hmail, params"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Params is a list of: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"[host, ip, response, delay, port, mode, ok_recips, secured]"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When mails are successfully delivered to the remote end then the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"delivered"}]},{"type":"text","value":"\nhook is called. The return codes from this hook have no effect, so it is only\nuseful for logging the fact that a successful delivery occurred."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"host"}]},{"type":"text","value":" - Hostname of the MX that the message was delivered to,"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"ip"}]},{"type":"text","value":" - IP address of the host that the message was delivered to,"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"response"}]},{"type":"text","value":" - Variable contains the SMTP response text returned by the host\nthat received the message and will typically contain the remote queue ID and"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"delay"}]},{"type":"text","value":" - Time taken between the queue file being created and the\nmessage being delivered."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"port"}]},{"type":"text","value":" - Port number that the message was delivered to."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mode"}]},{"type":"text","value":" - Shows whether SMTP or LMTP was used to deliver the mail."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"ok_recips"}]},{"type":"text","value":" - an "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Address"}]},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":" array containing all of the recipients that were\nsuccessfully delivered to."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"secured"}]},{"type":"text","value":" - A boolean denoting if the connection used TLS or not."}]}]},{"type":"element","tag":"h2","props":{"id":"outbound-ip-address"},"children":[{"type":"text","value":"Outbound IP address"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Normally the OS will decide which IP address will be used for outbound\nconnections using the IP routing table."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are instances where you may want to separate outbound traffic on\ndifferent IP addresses based on sender, domain or some other identifier."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nTo do this, the IP address that you want to use "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"must"}]},{"type":"text","value":" be bound to an\ninterface (or alias) on the local system."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"As described above the outbound IP can be set using the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"bind"}]},{"type":"text","value":" parameter\nand also the outbound helo for the IP can be set using the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"bind_ehlo"}]},{"type":"text","value":"\nparameter returned my the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"get_mx"}]},{"type":"text","value":" hook or during the reception of the message\nyou can set a transaction note in a plugin to tell Haraka which outbound IP\naddress you would like it to use when it tries to deliver the message:"}]},{"type":"element","tag":"code","props":{"code":"connection.transaction.notes.outbound_ip = '1.2.3.4';\nconnection.transaction.notes.outbound_helo = 'mail-2.example.com';\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"connection.transaction.notes.outbound_ip = '1.2.3.4';\nconnection.transaction.notes.outbound_helo = 'mail-2.example.com';\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note: if the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"get_mx"}]},{"type":"text","value":" hook returns a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"bind"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"bind_helo"}]},{"type":"text","value":" parameter, then\nthis will be used in preference to the transaction note."}]},{"type":"element","tag":"h2","props":{"id":"auth"},"children":[{"type":"text","value":"AUTH"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you wish to use AUTH for a particular domain or domains, or you wish to\nforce all mail to an outbound service or smart host that requires authentication\nthen you can use the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"get_mx"}]},{"type":"text","value":" hook documented above to do this by supplying\nboth "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"auth_user"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"auth_pass"}]},{"type":"text","value":" properties in an MX object."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If AUTH properties are supplied and the remote end does not offer AUTH or there\nare no compatible AUTH methods, then the message will be sent without AUTH and\na warning will be logged."}]},{"type":"element","tag":"h2","props":{"id":"bounce-messages"},"children":[{"type":"text","value":"Bounce Messages"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The contents of the bounce message are configured by a file called\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config/outbound.bounce_message"}]},{"type":"text","value":". If you look at this file you will see it\ncontains several template entries wrapped in curly brackets. These will be\npopulated as follows:"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Optional: Possibility to add HTML code (with optional image) to the bounce message is possible\nby adding the files "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config/outbound.bounce_message_html"}]},{"type":"text","value":". An image can be attached\nto the mail by using "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config/outbound.bounce_message_image"}]},{"type":"text","value":"."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"pid - the current process id"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"date - the current date when the bounce occurred"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"me - the contents of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config/me"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"from - the originating sender of the message"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"msgid - a uuid for the mail"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"to - the end recipient of the message, or the first recipient if it was to\nmultiple people"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"reason - the text from the remote server indicating why it bounced"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Following the bounce message itself will be a copy of the entire original\nmessage."}]},{"type":"element","tag":"h2","props":{"id":"creating-a-mail-internally-for-outbound-delivery"},"children":[{"type":"text","value":"Creating a mail internally for outbound delivery"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Sometimes it is necessary to generate a new mail from within a plugin."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To do that, you can use the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"outbound"}]},{"type":"text","value":" module directly:"}]},{"type":"element","tag":"code","props":{"code":"var outbound = require('./outbound');\n\nvar plugin = this;\n\nvar to = 'user@example.com';\nvar from = 'sender@example.com';\n\nvar contents = [\n    \"From: \" + from,\n    \"To: \" + to,\n    \"MIME-Version: 1.0\",\n    \"Content-type: text/plain; charset=us-ascii\",\n    \"Subject: Some subject here\",\n    \"\",\n    \"Some email body here\",\n    \"\"].join(\"\\n\");\n    \nvar outnext = function (code, msg) {\n    switch (code) {\n        case DENY:  plugin.logerror(\"Sending mail failed: \" + msg);\n                    break;\n        case OK:    plugin.loginfo(\"mail sent\");\n                    next();\n                    break;\n        default:    plugin.logerror(\"Unrecognized return code from sending email: \" + msg);\n                    next();\n    }\n};\n\noutbound.send_email(from, to, contents, outnext);\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"var outbound = require('./outbound');\n\nvar plugin = this;\n\nvar to = 'user@example.com';\nvar from = 'sender@example.com';\n\nvar contents = [\n    \"From: \" + from,\n    \"To: \" + to,\n    \"MIME-Version: 1.0\",\n    \"Content-type: text/plain; charset=us-ascii\",\n    \"Subject: Some subject here\",\n    \"\",\n    \"Some email body here\",\n    \"\"].join(\"\\n\");\n    \nvar outnext = function (code, msg) {\n    switch (code) {\n        case DENY:  plugin.logerror(\"Sending mail failed: \" + msg);\n                    break;\n        case OK:    plugin.loginfo(\"mail sent\");\n                    next();\n                    break;\n        default:    plugin.logerror(\"Unrecognized return code from sending email: \" + msg);\n                    next();\n    }\n};\n\noutbound.send_email(from, to, contents, outnext);\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The callback on "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"send_email()"}]},{"type":"text","value":" is passed "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"OK"}]},{"type":"text","value":" if the mail is successfully\nqueued to disk, not when it is successfully delivered. To check delivery\nstatus you still need to hook "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"delivered"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"bounce"}]},{"type":"text","value":" to know if it was\nsuccessfully delivered."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The callback parameter may be omitted if you don't need to handle errors\nshould queueing to disk fail e.g:"}]},{"type":"element","tag":"code","props":{"code":"outbound.send_email(from, to, contents);\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"outbound.send_email(from, to, contents);\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can pass various options to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"outbound.send_email"}]},{"type":"text","value":" like so:"}]},{"type":"element","tag":"code","props":{"code":"outbound.send_email(from, to, contents, outnext, options);\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"outbound.send_email(from, to, contents, outnext, options);\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Where "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"options"}]},{"type":"text","value":" is a Object that may contain the following keys:"}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"Key/Value"}]},{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"Description"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"dot_stuffed: true"}]}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"Use this if you are passing your content dot-stuffed (a dot at the start of a line is doubled, like it is in SMTP conversation, see "},{"type":"element","tag":"a","props":{"href":"https://tools.ietf.org/html/rfc2821#section-4.5.2","rel":["nofollow"]},"children":[{"type":"text","value":"RFC 2821"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"notes: { key: value}"}]}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"In case you need notes in the new transaction that "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"send_email()"}]},{"type":"text","value":" creates."}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"remove_msgid: true"}]}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"Remove any Message-Id header found in the message.  If you are reading a message in from the filesystem and you want to ensure that a generated Message-Id header is used in preference over the original.  This is useful if you are releasing mail from a quarantine."}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"remove_date: true"}]}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"Remove any Date header found in the message.  If you are reading a message in from the filesystem and you want to ensure that a generated Date header is used in preference over the original.  This is useful if you are releasing mail from a quarantine."}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"origin: Object"}]}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"Adds object as argument to logger.log calls inside outbound.send_email. Useful for tracking which Plugin/Connection/HMailItem object generated email."}]}]}]}]},{"type":"element","tag":"code","props":{"code":"    outbound.send_email(from, to, contents, outnext, { notes: transaction.notes });\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    outbound.send_email(from, to, contents, outnext, { notes: transaction.notes });\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":": "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Address"}]},{"type":"text","value":" objects are "},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/node-address-rfc2821","rel":["nofollow"]},"children":[{"type":"text","value":"address-rfc2821 objects"}]},{"type":"text","value":"."}]}]},"navigation":{"title":"Outbound"},"_type":"markdown","_id":"content:6.core:12.Outbound.md","_source":"content","_file":"6.core/12.Outbound.md","_extension":"md"}]