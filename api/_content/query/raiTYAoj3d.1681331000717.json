{"_path":"/plugins/rate_limit","_dir":"plugins","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"rate_limit - Rate limit connections plugin for Haraka","description":"Haraka rate_limit plugin - Rate limit connections","navigation":{"title":"rate_limit"},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"rate_limit-plugin"},"children":[{"type":"text","value":"rate_limit plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Enforce limits on connection concurrency, connection rate, and recipient rate."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By default DENYSOFT will be returned when the limits are exceeded, but for\nconcurrency, connection rate and recipient rate by host you can optionally\ntarpit the connection by adding a delay before every response sent back to the\nclient instead of sending a DENYSOFT.  To do this requires the 'tarpit' plugin\nto run immediately after this plugin."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To use this plugin you will need a Redis server and will need the redis,\nhiredis and ipaddr.js packages installed via:"}]},{"type":"element","tag":"code","props":{"code":"cd /path/to/haraka/home\nnpm install redis hiredis ipaddr.js\n","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"cd /path/to/haraka/home\nnpm install redis hiredis ipaddr.js"}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"configuration"},"children":[{"type":"text","value":"Configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin uses the configuration file rate_limit.ini which is checked for\nupdates before each hook, so changes to this file will never require a restart\nand will take effect seconds after the changes are saved."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The configuration options for each heading are detailed below:"}]},{"type":"element","tag":"h3","props":{"id":"main"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"main"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"redis_server = <ip | host>"},{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"port","props":{},"children":[]}]},{"type":"text","value":" "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"(optional)"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"If port is missing then it defaults to 6379."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nIf this setting is missing entirely then it defaults to 127.0.0.1:6379."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Note that Redis does not currently support IPv6."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"tarpit_delay = seconds "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"(optional)"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Set this to the length in seconds that you want to delay every SMTP\nresponse to a remote client that has exceeded the rate limits.  For this\nto work the 'tarpit' plugin must be loaded "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"after"}]},{"type":"text","value":" this plugin in\nconfig/plugins."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"If 'tarpit' is not loaded or is loaded before this plugin, then no\nrate throttling will occur."}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All of the following sections are optional.  Any missing section disables\nthat particular test."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"They all use a common configuration format:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"<lookup> = <limit>"},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"/time"},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"unit"}]}]},{"type":"text","value":"  "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"(optional)"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"'lookup' is based upon the limit being enforced and is either an IP\naddress, rDNS name, sender address or recipient address either in full\nor part."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\nThe lookup order is as follows and the first match in this order is\nreturned and is used as the record key in Redis (except for 'default'\nwhich always uses the full lookup for that test as the record key):"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"IPv4/IPv6 address or rDNS hostname:"}]},{"type":"text","value":" "},{"type":"element","tag":"pre","props":{},"children":[{"type":"text","value":" fe80:0:0:0:202:b3ff:fe1e:8329\n fe80:0:0:0:202:b3ff:fe1e\n fe80:0:0:0:202:b3ff\n fe80:0:0:0:202\n fe80:0:0:0\n fe80:0:0\n fe80:0\n fe80\n 1.2.3.4\n 1.2.3\n 1.2\n 1\n host.part.domain.com\n part.domain.com\n domain.com\n com\n default\n "}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Sender or Recipient address:"}]},{"type":"text","value":" "},{"type":"element","tag":"pre","props":{},"children":[{"type":"text","value":" user@host.sub.part.domain.com\n host.sub.part.domain.com\n sub.part.domain.com\n part.domain.com\n domain.com\n com\n default\n "}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"In all tests 'default' is used to specify a default limit if nothing else has\nmatched."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"'limit' specifies the limit for this lookup.  Specify 0 (zero) to disable\nlimits on a matching lookup."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"'time' is optional and if missing defaults to 60 seconds.  You can optionally\nspecify the following time units (case-insensitive):"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"s (seconds)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"m (minutes)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"h (hours)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"d (days)"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"concurrency"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"concurrency"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"IMPORTANT NOTE:"}]},{"type":"text","value":" connection concurrency is recorded in-memory (in\nconnection.server.notes) and not in Redis, so the limits are per-server and\nper-child if you use the cluster module."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"IP and rDNS names are looked up by this test.  This section does "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"not"}]},{"type":"text","value":" accept an\ninterval.  It's a hard limit on the number of connections and not based on time."}]},{"type":"element","tag":"h3","props":{"id":"rate_conn"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_conn"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the number of connections per interval from a given host\nor set of hosts."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"IP and rDNS names are looked up by this test."}]},{"type":"element","tag":"h3","props":{"id":"rate_rcpt_host"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_rcpt_host"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the number of recipients per interval from a given host or\nset of hosts."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"IP and rDNS names are looked up by this test."}]},{"type":"element","tag":"h3","props":{"id":"rate_rcpt_sender"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_rcpt_sender"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the number of recipients per interval from a sender or\nsender domain."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The sender is looked up by this test."}]},{"type":"element","tag":"h3","props":{"id":"rate_rcpt"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_rcpt"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the rate which a recipient or recipient domain can\nreceive messages over an interval."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each recipient is looked up by this test."}]},{"type":"element","tag":"h3","props":{"id":"rate_rcpt_null"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"rate_rcpt_null"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This section limits the rate at which a recipient can receive messages from\na null sender (e.g. DSN, MDN etc.) over an interval."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Each recipient is looked up by this test."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"configuration","depth":2,"text":"Configuration","children":[{"id":"main","depth":3,"text":"main"},{"id":"concurrency","depth":3,"text":"concurrency"},{"id":"rate_conn","depth":3,"text":"rate_conn"},{"id":"rate_rcpt_host","depth":3,"text":"rate_rcpt_host"},{"id":"rate_rcpt_sender","depth":3,"text":"rate_rcpt_sender"},{"id":"rate_rcpt","depth":3,"text":"rate_rcpt"},{"id":"rate_rcpt_null","depth":3,"text":"rate_rcpt_null"}]}]}},"_type":"markdown","_id":"content:8.plugins:rate_limit.md","_source":"content","_file":"8.plugins/rate_limit.md","_extension":"md"}