{"_path":"/plugins/elasticsearch","_dir":"plugins","_draft":false,"_partial":false,"_locale":"","title":"elasticsearch - Logs to Elasticsearch plugin for Haraka","description":"Haraka elasticsearch plugin - Logs to Elasticsearch","navigation":{"title":"elasticsearch"},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"haraka-plugin-elasticsearch"},"children":[{"type":"text","value":"haraka-plugin-elasticsearch"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ship Haraka log info directly to Elasticsearch"}]},{"type":"element","tag":"h2","props":{"id":"install"},"children":[{"type":"text","value":"INSTALL"}]},{"type":"element","tag":"pre","props":{"code":"cd /path/to/local/haraka\nnpm install haraka-plugin-elasticsearch\necho \"elasticsearch\" >> config/plugins\nservice haraka restart\n","language":"sh","meta":"","className":"language-sh shiki shiki-themes github-dark github-light","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5"},"children":[{"type":"text","value":"cd"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" /path/to/local/haraka\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1"},"children":[{"type":"text","value":"npm"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" install"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" haraka-plugin-elasticsearch\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5"},"children":[{"type":"text","value":"echo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" \"elasticsearch\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49"},"children":[{"type":"text","value":" >>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" config/plugins\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1"},"children":[{"type":"text","value":"service"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" haraka"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" restart\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"configuration"},"children":[{"type":"text","value":"Configuration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If the default configuration is not sufficient, copy the config file from the distribution into your haraka config dir and then modify it:"}]},{"type":"element","tag":"pre","props":{"code":"cp node_modules/haraka-plugin-elasticsearch/config/elasticsearch.ini\nconfig/elasticsearch.ini\n$EDITOR config/elasticsearch.ini\n","language":"sh","meta":"","className":"language-sh shiki shiki-themes github-dark github-light","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1"},"children":[{"type":"text","value":"cp"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" node_modules/haraka-plugin-elasticsearch/config/elasticsearch.ini\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1"},"children":[{"type":"text","value":"config/elasticsearch.ini\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E"},"children":[{"type":"text","value":"$EDITOR config/elasticsearch.ini\n"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"logging"},"children":[{"type":"text","value":"Logging"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Unless errors are encountered, no logs are emitted."}]},{"type":"element","tag":"h3","props":{"id":"errors"},"children":[{"type":"text","value":"Errors"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The elasticsearch module has very robust error handling built in. If there's a\nconnection issue, errors such as these will be emitted when Haraka starts\nup:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Elasticsearch cluster is down!"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"No Living connections"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, ES will continue attempting to connect and when the ES server(s) are\navailable, logging will begin. If errors are encountered trying to save data\nto ES, they look like this:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"No Living connections"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Request Timeout after 30000ms"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"They normally fix themselves when ES resumes working properly."}]},{"type":"element","tag":"h2","props":{"id":"configuration-1"},"children":[{"type":"text","value":"Configuration"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"host - an IP or hostname of the ES server to connect to"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"host=127.0.0.2"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"pluginObject"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By default, all plugin results are presented as "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"$plugin_name: { ... }"}]},{"type":"text","value":", at\nthe top level. If you prefer that all plugin results be nested inside an\nobject "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"$obj: { $plugin_name: { ...}"}]},{"type":"text","value":", set pluginObject to that object's key name"}]},{"type":"element","tag":"pre","props":{"code":"pluginObject=plugin\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"pluginObject=plugin\n"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"ignore_hosts"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A config file section for hosts whose results should not be stored in\nES. HAproxy servers, Nagios, and other hosts who monitor Haraka can be listed\nhere. The format for entries is host.name=true"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"index"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"transaction=smtp-transaction\nconnection=smtp-connection"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Transactions include all the connection information and are \"the good stuff.\"\nWhen a connection has transactions, the connection is not saved separately.\nThe distinction is that a connection is stored only when it has zero\ntransactions. The connections index tends to be mostly noise (monitoring,\nblocked connections, bruteforce auth attempts, etc.). To collapse them into\nthe same index, set the value for both identically."}]},{"type":"element","tag":"h2","props":{"id":"index-templates"},"children":[{"type":"text","value":"Index Templates"}]},{"type":"element","tag":"h3","props":{"id":"composable-index-templates"},"children":[{"type":"text","value":"Composable Index Templates"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Composable templates are the modern (circa 2025) method of creating index templates. In the file ./test/template.js, there are unit tests with working JS code that install the component templates as well as the index template that uses them. If you're standing up a new ES cluster, copy/pasting that into a .js file will get you bootstrapped fairly quickly."}]},{"type":"element","tag":"h3","props":{"id":"legacy-index-template"},"children":[{"type":"text","value":"Legacy Index Template"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Creating an index template will apply the template(s) to any future indexes that\nmatch the pattern/name in the template setting. This is how to manually apply\nan index map template from the sample file in this package:"}]},{"type":"element","tag":"pre","props":{"code":"curl -X PUT 'http://localhost:9200/_template/haraka_results' \\\n     -H 'Content-Type: application/json' -d @templates/index/v8.json\n","language":"sh","meta":"","className":"language-sh shiki shiki-themes github-dark github-light","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1"},"children":[{"type":"text","value":"curl"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5"},"children":[{"type":"text","value":" -X"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" PUT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" 'http://localhost:9200/_template/haraka_results'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5"},"children":[{"type":"text","value":" \\\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5"},"children":[{"type":"text","value":"     -H"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" 'Content-Type: application/json'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5"},"children":[{"type":"text","value":" -d"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62"},"children":[{"type":"text","value":" @templates/index/v8.json\n"}]}]}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"install","depth":2,"text":"INSTALL","children":[{"id":"configuration","depth":3,"text":"Configuration"},{"id":"logging","depth":3,"text":"Logging"},{"id":"errors","depth":3,"text":"Errors"}]},{"id":"configuration-1","depth":2,"text":"Configuration"},{"id":"index-templates","depth":2,"text":"Index Templates","children":[{"id":"composable-index-templates","depth":3,"text":"Composable Index Templates"},{"id":"legacy-index-template","depth":3,"text":"Legacy Index Template"}]}]}},"_type":"markdown","_id":"content:8.plugins:elasticsearch.md","_source":"content","_file":"8.plugins/elasticsearch.md","_stem":"8.plugins/elasticsearch","_extension":"md"}