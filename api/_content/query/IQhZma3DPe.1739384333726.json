{"_path":"/plugins/karma","_dir":"plugins","_draft":false,"_partial":false,"_locale":"","title":"karma - a scoring engine plugin for Haraka","description":"Haraka karma plugin - a scoring engine for Haraka","navigation":{"title":"karma"},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"karma-plugin"},"children":[{"type":"text","value":"karma plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma is a heuristic scoring engine that uses connection metadata and other Haraka plugins as inputs. Connections scoring in excess of specified thresholds are rewarded or "},{"type":"element","tag":"a","props":{"href":"#penalties"},"children":[{"type":"text","value":"penalized"}]},{"type":"text","value":" in proportionate ways."}]},{"type":"element","tag":"h2","props":{"id":"description"},"children":[{"type":"text","value":"Description"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Haraka includes some excellent plugins that detect message or sender patterns that are indicative of spam. "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/plugins/spamassassin","rel":["nofollow"]},"children":[{"type":"text","value":"Some"}]},{"type":"text","value":" "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/plugins/messagesniffer","rel":["nofollow"]},"children":[{"type":"text","value":"plugins"}]},{"type":"text","value":" "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/plugins/connect.fcrdns","rel":["nofollow"]},"children":[{"type":"text","value":"have"}]},{"type":"text","value":" "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/plugins/data.uribl","rel":["nofollow"]},"children":[{"type":"text","value":"accuracy"}]},{"type":"text","value":" rates above 95%. Detecting messages incorrectly 5% of the time means that some portion of ham will get blocked and some portion of spam will get delivered. The traditional solution is to permit users to specify their filtering aggressiveness, and then suffer the consequences (blocked ham -vs- too much spam)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By scoring and weighting several \"95+\" plugins, accuracy rates above 99% are attainable. With a half dozen such plugins, "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"99.99% accuracy"}]},{"type":"text","value":" is attainable. With karma, good senders with good history can occasionally fail tests (false positives) and still deliver their mail. Senders with poor history will have a much harder time."}]},{"type":"element","tag":"h3","props":{"id":"karma-prereqs"},"children":[{"type":"text","value":"Karma Prereqs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One challenge for mail filtering is that filters (or plugins, in Haraka's case) are usually called in sequence. A message passes from one filter to the next in a pipeline and each filter gets to choose \"yeah or nay.\" In order for karma to transcend this limit, karma requires that "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"every"}]},{"type":"text","value":" filter passes every message. Nearly all Haraka plugins have a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"reject"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"deny"}]},{"type":"text","value":" option for this reason."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In order to score a filters results, filters must save their results to the "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/core/Results","rel":["nofollow"]},"children":[{"type":"text","value":"Result Store"}]},{"type":"text","value":". Karma will see that and apply the award specified in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"karma.ini"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"how-karma-works"},"children":[{"type":"text","value":"How Karma Works"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma takes a holistic view of "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"connections"}]},{"type":"text","value":". During the connection, karma collects these results and applies the "},{"type":"element","tag":"a","props":{"href":"#awards"},"children":[{"type":"text","value":"result_awards"}]},{"type":"text","value":" defined in "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"karma.ini"}]},{"type":"text","value":". Once a connection/message exceeds the threshold.negative score (default: -8), karma rejects it at the next "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"deny"}]},{"type":"text","value":"hook."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The scoring mechanism is not dissimilar to "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/plugins/spamassassin","rel":["nofollow"]},"children":[{"type":"text","value":"SpamAssassin"}]},{"type":"text","value":", but Karma has some particular advantages:"}]},{"type":"element","tag":"pre","props":{"code":"* Runs entirely in Node, so it's very fast\n* Async and very scalable.\n* Builds sender and network reputation databases\n* Has access to connection properties (relaying, port, auth attempts, etc..)\n* Access to raw SMTP commands (data + formatting inspection)\n* Can reject connections before DATA (save lots of bandwidth)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"* Runs entirely in Node, so it's very fast\n* Async and very scalable.\n* Builds sender and network reputation databases\n* Has access to connection properties (relaying, port, auth attempts, etc..)\n* Access to raw SMTP commands (data + formatting inspection)\n* Can reject connections before DATA (save lots of bandwidth)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma is not a replacement for content filters. Karma focuses on the quality of the "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"connection"}]},{"type":"text","value":". Content filters (bayes*) focus on the content of the "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"message"}]},{"type":"text","value":". Karma works best "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"with"}]},{"type":"text","value":" content filters."}]},{"type":"element","tag":"h1","props":{"id":"config"},"children":[{"type":"text","value":"CONFIG"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"See config/karma.ini for options and inline documentation."}]},{"type":"element","tag":"h2","props":{"id":"awards"},"children":[{"type":"text","value":"AWARDS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma allows the site administrator to control how much weight to assign to\nplugin results, providing a great deal of control over what results are\nworth rejecting for."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma begins scoring the connection when the first packet arrives. The IP reputation, "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/plugins/connect.p0f","rel":["nofollow"]},"children":[{"type":"text","value":"sender OS"}]},{"type":"text","value":", "},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/haraka-plugin-geoip","rel":["nofollow"]},"children":[{"type":"text","value":"GeoIP location"}]},{"type":"text","value":", "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/plugins/dnsbl","rel":["nofollow"]},"children":[{"type":"text","value":"DNSBL"}]},{"type":"text","value":" listing, and "},{"type":"element","tag":"a","props":{"href":"http://haraka.github.io/plugins/connect.fcrdns","rel":["nofollow"]},"children":[{"type":"text","value":"FCrDNS"}]},{"type":"text","value":" are often a sufficient basis for rejecting a connection without ever blocking a ham."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma performs checks early and often, maximizing the penality it can exact upon bad mailers."}]},{"type":"element","tag":"h2","props":{"id":"penalties"},"children":[{"type":"text","value":"Penalties"}]},{"type":"element","tag":"h3","props":{"id":"deny-reject"},"children":[{"type":"text","value":"Deny / Reject"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When connections become worse than "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"thresholds"}]},{"type":"text","value":"negative, they are denied during the next "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"deny"}]},{"type":"text","value":"hook."}]},{"type":"element","tag":"h3","props":{"id":"history"},"children":[{"type":"text","value":"History"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma history is computed as the number of good - bad connections."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When each connection ends, "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"karma"}]},{"type":"text","value":" records the result. When a sufficient history has been built for an IP or ASN, future connections from that address(es) will get a positive or negative karma award."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The reward is purposefully small, to permit good senders in bad neighborhoods to still send."}]},{"type":"element","tag":"h3","props":{"id":"connection-delays"},"children":[{"type":"text","value":"Connection Delays"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Connection delays (aka tarpitting, teergrubing, early talker) slow down a SMTP conversation by inserting artificial delays. Karma increases connection delays adaptively as connection quality changes."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma's delay goals:"}]},{"type":"element","tag":"pre","props":{"code":"1. Don't delay valid senders\n2. Penalize senders in proportion to their karma score\n3. Dampen bruteforce AUTH attacks.\n4. Since the only *cost* we can exact from miscreants is time, and connections are cheap to maintain, keep miscreants online as long as possible.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"1. Don't delay valid senders\n2. Penalize senders in proportion to their karma score\n3. Dampen bruteforce AUTH attacks.\n4. Since the only *cost* we can exact from miscreants is time, and connections are cheap to maintain, keep miscreants online as long as possible.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are three tarpit options:"}]},{"type":"element","tag":"pre","props":{"code":"[tarpit]\n* delay=0   (seconds to delay,      default: 0)\n* max=5     (max seconds to delay,  default: 5)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[tarpit]\n* delay=0   (seconds to delay,      default: 0)\n* max=5     (max seconds to delay,  default: 5)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When set to zero, the value of the delay is adaptive, calculated proportional\nto the karma score of the connection. Connections with good karma will see no\ndelay and bad ones will see long delays."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When delay is non-zero, each SMTP response will be delayed by that many seconds."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In practice, most naughty senders abandon the connection when forced to\nwait more than a handful of seconds. "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"max"}]},{"type":"text","value":" sets the maximum delay between\nresponses."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"karma"}]},{"type":"text","value":", do not use Haraka's "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"tarpit"}]},{"type":"text","value":" plugin."}]},{"type":"element","tag":"h2","props":{"id":"included-tests"},"children":[{"type":"text","value":"Included Tests"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Connection data that karma considers:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#IP_Reputation"},"children":[{"type":"text","value":"IP Reputation"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#Neighbor_Reputation"},"children":[{"type":"text","value":"ASN reputation"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DENY events by other plugins"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"envelope sender from a spammy TLD"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#malformed_env"},"children":[{"type":"text","value":"malformed envelope addresses"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#unrecognized"},"children":[{"type":"text","value":"unrecognized SMTP commands"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"matching "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"env from"}]},{"type":"text","value":" and "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"env to"}]},{"type":"text","value":" name (rare in ham, frequent in spam)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The data from these tests are helpful but the real power of karma is "},{"type":"element","tag":"a","props":{"href":"#awards"},"children":[{"type":"text","value":"scoring\nthe results"}]},{"type":"text","value":" of other plugins. See karma.ini for a rich set of examples."}]},{"type":"element","tag":"h3","props":{"id":"ip-reputation"},"children":[{"type":"element","tag":"a","props":{"name":"IP_Reputation"},"children":[]},{"type":"text","value":"IP Reputation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma records the number of good, bad, and total connections.  The results\nare accessible to other plugins as well."}]},{"type":"element","tag":"pre","props":{"code":"var karma = connection.results.get('karma');\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"var karma = connection.results.get('karma');\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The karma result object contains at least the following:"}]},{"type":"element","tag":"pre","props":{"code":"score: 0,         <- score for this connection\nhistory: 0,       <- score for all connections\n   good: 0,       <- qty of past 'good' connections\n   bad: 0,        <- qty of past 'bad' connections\nconnections: 0,   <- total past connections\npass: [],         <- tests that added positive karma\nfail: [],         <- tests that added negative karma\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"score: 0,         <- score for this connection\nhistory: 0,       <- score for all connections\n   good: 0,       <- qty of past 'good' connections\n   bad: 0,        <- qty of past 'bad' connections\nconnections: 0,   <- total past connections\npass: [],         <- tests that added positive karma\nfail: [],         <- tests that added negative karma\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If an IP has at least 5 connections and all are good or bad, and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"all_good"}]},{"type":"text","value":" or\n"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"all_bad"}]},{"type":"text","value":" result will be added to the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pass"}]},{"type":"text","value":" or "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"fail"}]},{"type":"text","value":" test list. This are\nvery good indicators of future connection quality and are scored in karma.ini."}]},{"type":"element","tag":"h3","props":{"id":"asn-network-neighborhood-reputation"},"children":[{"type":"element","tag":"a","props":{"name":"Neighbor_Reputation"},"children":[]},{"type":"text","value":"ASN / Network Neighborhood Reputation"}]},{"type":"element","tag":"pre","props":{"code":"[asn]\nenable=true    (default: true)\nreport_as\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"[asn]\nenable=true    (default: true)\nreport_as\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"asn"}]},{"type":"text","value":"enable is true, karma records the number of good and bad\nconnections from each ASN."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ASNs with less than 5 karma points in either direction are ignored."}]},{"type":"element","tag":"h4","props":{"id":"report_as"},"children":[{"type":"text","value":"report_as"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Store the ASN results as another plugin. Example: I set "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"report_as=asn"}]},{"type":"text","value":", so that karma history for an ASN is reported with the ASN plugin data. A practical consequence of changing report_as is that the award location in karma.ini would need to change from:"}]},{"type":"element","tag":"pre","props":{"code":"NNN karma | pass | equals | asn_all_good |  2\nNNN karma | fail | equals | asn_all_bad  | -3\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"NNN karma | pass | equals | asn_all_good |  2\nNNN karma | fail | equals | asn_all_bad  | -3\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"to:"}]},{"type":"element","tag":"pre","props":{"code":"NNN asn | pass | equals | asn_all_good |  2\nNNN asn | fail | equals | asn_all_bad  | -3\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"NNN asn | pass | equals | asn_all_good |  2\nNNN asn | fail | equals | asn_all_bad  | -3\n"}]}]},{"type":"element","tag":"h3","props":{"id":"malformed-envelope-addresses"},"children":[{"type":"element","tag":"a","props":{"name":"malformed_env"},"children":[]},{"type":"text","value":"Malformed Envelope Addresses"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Very old versions of Outlook Express and some malware senders don't bother complying with the RFC (5321, 2821, 821) address format. Karma checks the envelope from and to addresses for a common RFC ignorant pattern that is highly correlated with malware."}]},{"type":"element","tag":"h3","props":{"id":"unrecognized-smtp-verbscommands"},"children":[{"type":"element","tag":"a","props":{"name":"unrecognized"},"children":[]},{"type":"text","value":"Unrecognized SMTP verbs/commands"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Certain bruteforce password hacking tools have a pre-programmed SMTP path\nthat ignores SMTP responses. After EHLO, they attempt AUTH,LOGIN with a valid\nusername. To bruteforce a password often requires millions of attempts so each\nbot sprays a couple dozen connections at the target server. Better quality\nMTAs like Haraka have built-in auth protection that inserts timeouts\nbetween successive auth attempts. The bots work around that by dropping the\nconnection after each failure and reconnecting. The attempts are distributed\nso IP blocking is of limited effectiveness."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To combat these bruteforce attacks several strategies are called for:"}]},{"type":"element","tag":"pre","props":{"code":"1. Impose [connection delays](#delay)\n2. Disable SMTP-AUTH when not encrypted. The bots rarely use STARTTLS.\n   Besides preventing user passwords from transiting the internet in clear\n   text, requiring TLS encryption also means AUTH is not available to\n   poorly written bots.\n3. Having done #2, bot AUTH attempts show up as unrecognized commands.\n   Penalizing these with tarpitting and rate limiting will almost never\n   harm a legit sender but it will make it take much much longer for\n   attackers to bruteforce passwords.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"1. Impose [connection delays](#delay)\n2. Disable SMTP-AUTH when not encrypted. The bots rarely use STARTTLS.\n   Besides preventing user passwords from transiting the internet in clear\n   text, requiring TLS encryption also means AUTH is not available to\n   poorly written bots.\n3. Having done #2, bot AUTH attempts show up as unrecognized commands.\n   Penalizing these with tarpitting and rate limiting will almost never\n   harm a legit sender but it will make it take much much longer for\n   attackers to bruteforce passwords.\n"}]}]},{"type":"element","tag":"h2","props":{"id":"limitations"},"children":[{"type":"text","value":"LIMITATIONS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Karma is most effective at filtering mail delivered by bots and rogue servers.\nSpam delivered by servers with good reputations normally pass karma's checks.\nExpect to use karma "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"with"}]},{"type":"text","value":" content filters."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"description","depth":2,"text":"Description","children":[{"id":"karma-prereqs","depth":3,"text":"Karma Prereqs"}]},{"id":"how-karma-works","depth":2,"text":"How Karma Works"},{"id":"awards","depth":2,"text":"AWARDS"},{"id":"penalties","depth":2,"text":"Penalties","children":[{"id":"deny-reject","depth":3,"text":"Deny / Reject"},{"id":"history","depth":3,"text":"History"},{"id":"connection-delays","depth":3,"text":"Connection Delays"}]},{"id":"included-tests","depth":2,"text":"Included Tests","children":[{"id":"ip-reputation","depth":3,"text":"IP Reputation"},{"id":"asn-network-neighborhood-reputation","depth":3,"text":"ASN / Network Neighborhood Reputation"},{"id":"malformed-envelope-addresses","depth":3,"text":"Malformed Envelope Addresses"},{"id":"unrecognized-smtp-verbscommands","depth":3,"text":"Unrecognized SMTP verbs/commands"}]},{"id":"limitations","depth":2,"text":"LIMITATIONS"}]}},"_type":"markdown","_id":"content:8.plugins:karma.md","_source":"content","_file":"8.plugins/karma.md","_stem":"8.plugins/karma","_extension":"md"}