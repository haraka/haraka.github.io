{"_path":"/core/HAProxy","_dir":"core","_draft":false,"_partial":false,"_locale":"","title":"HAProxy PROXY protocol extension support","description":"Haraka natively supports the PROXY protocol 1.","navigation":{"title":"HAProxy"},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"haproxy"},"children":[{"type":"text","value":"HAProxy"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Haraka natively supports the PROXY protocol "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This allows an upstream proxy to pass IP address and port of the client which\nHaraka will use instead of the socket IP address (which is of the proxy).\nThis allows DNSBLs and access control lists to operate on the proxied address."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Support is disabled by default and if HAProxy or other attempts to send a\nPROXY command then Haraka will return a DENYSOFTDISCONNECT error.\nDENYSOFT is used to prevent configuration errors from rejecting valid mail."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To enable support for PROXY you must create a "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"haproxy_hosts"}]},{"type":"text","value":" configuration\nfile which should contain a list of IP addresses of the HAProxy hosts\nthat should be allowed to send the PROXY command. A range of IP\naddresses can be specified by it's CIDR network address."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When a host connects to Haraka that matches an IP address present in the\n"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"haproxy_hosts"}]},{"type":"text","value":" file - a banner is not sent, instead Haraka waits for the\nPROXY command to be sent before proceeding.  The connection will timeout\nwith "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"421 PROXY timed out"}]},{"type":"text","value":" if the command is not sent within 30 seconds."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"NOTE: because Haraka does not send a banner when a listed HAProxy host\nconnects you must set check-send-proxy to ensure that the service checks\nsend a PROXY command before they run."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":" "},{"type":"element","tag":"a","props":{"href":"http://haproxy.1wt.eu/download/1.5/doc/proxy-protocol.txt","rel":["nofollow"]},"children":[{"type":"text","value":"http://haproxy.1wt.eu/download/1.5/doc/proxy-protocol.txt"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"HAProxy supports the PROXY protocol in version 1.5 or later however there\nare patches available to add support for 1.4."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is an example listener section for haproxy.cfg:"}]},{"type":"element","tag":"pre","props":{"code":"listen smtp :25\n        mode tcp\n        option tcplog\n        option smtpchk\n        balance roundrobin\n        server smtp1 ip.of.haraka.server1:25 check-send-proxy check inter 10s send-proxy\n        server smtp2 ip.of.haraka.server2:25 check-send-proxy check inter 10s send-proxy\n        server smtp3 ip.of.haraka.server3:25 check-send-proxy check inter 10s send-proxy\n        server smtp4 ip.of.haraka.server4:25 check-send-proxy check inter 10s send-proxy\n        server smtp5 ip.of.haraka.server5:25 check-send-proxy check inter 10s send-proxy\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"listen smtp :25\n        mode tcp\n        option tcplog\n        option smtpchk\n        balance roundrobin\n        server smtp1 ip.of.haraka.server1:25 check-send-proxy check inter 10s send-proxy\n        server smtp2 ip.of.haraka.server2:25 check-send-proxy check inter 10s send-proxy\n        server smtp3 ip.of.haraka.server3:25 check-send-proxy check inter 10s send-proxy\n        server smtp4 ip.of.haraka.server4:25 check-send-proxy check inter 10s send-proxy\n        server smtp5 ip.of.haraka.server5:25 check-send-proxy check inter 10s send-proxy\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The important part is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"send-proxy"}]},{"type":"text","value":" which causes HAProxy to send the PROXY\nextension on connection."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When using "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"option smtpchk"}]},{"type":"text","value":" you will see CONNRESET errors reported in the Haraka logs as\nsmtpchk drops the connection before the HELO response is still being written.\nYou can use the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"option tcp-check"}]},{"type":"text","value":" instead to provide a better service check by having\nthe check wait for the banner, send QUIT and then check the response:"}]},{"type":"element","tag":"pre","props":{"code":"    option tcp-check\n    tcp-check expect rstring ^220\\ \n    tcp-check send QUIT\\r\\n\n    tcp-check expect rstring ^221\\ \n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    option tcp-check\n    tcp-check expect rstring ^220\\ \n    tcp-check send QUIT\\r\\n\n    tcp-check expect rstring ^221\\ \n"}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:6.core:7.HAProxy.md","_source":"content","_file":"6.core/7.HAProxy.md","_stem":"6.core/7.HAProxy","_extension":"md"}