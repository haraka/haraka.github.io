[{"_path":"/core/Plugins","_dir":"core","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Plugins","description":"Most aspects of receiving an email in Haraka are controlled by plugins. Mail cannot even be received unless at least a 'rcpt' and 'queue' plugin are\nenabled.","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"plugins"},"children":[{"type":"text","value":"Plugins"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Most aspects of receiving an email in Haraka are controlled by plugins. Mail cannot even be received unless at least a 'rcpt' and 'queue' plugin are\nenabled."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Recipient ("},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"rcpt"}]},{"type":"text","value":") plugins determine if a particular recipient is allowed to be relayed or received for. A "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"queue"}]},{"type":"text","value":" plugin queues the message somewhere - normally to disk or to an another SMTP server."}]},{"type":"element","tag":"h2","props":{"id":"plugin-lists"},"children":[{"type":"text","value":"Plugin Lists"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Get a list of installed plugins by running "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"haraka -l"}]},{"type":"text","value":". To include locally installed plugins, add the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"-c /path/to/config"}]},{"type":"text","value":" option."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We also have a "},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/Haraka/blob/master/Plugins.md","rel":["nofollow"]},"children":[{"type":"text","value":"registry of known plugins"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Display the help text for a plugin by running:"}]},{"type":"element","tag":"code","props":{"code":"haraka -h <name> -c /path/to/config`\n","language":"bash"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"haraka -h <name> -c /path/to/config`\n"}]}]}]},{"type":"element","tag":"h1","props":{"id":"writing-haraka-plugins"},"children":[{"type":"text","value":"Writing Haraka Plugins"}]},{"type":"element","tag":"h2","props":{"id":"anatomy-of-a-plugin"},"children":[{"type":"text","value":"Anatomy of a Plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plugins in Haraka are JS files in the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"plugins"}]},{"type":"text","value":" directory (legacy) and npm\nmodules in the node_modules directory. See \"Plugins as Modules\" below."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plugins can be installed in the Haraka global directory (default:\n/$os/$specific/lib/node_modules/Haraka) or in the Haraka install directory\n(whatever you chose when you typed "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"haraka -i"}]},{"type":"text","value":". Example: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"haraka -i /etc/haraka"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To enable a plugin, add its name to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config/plugins"}]},{"type":"text","value":". For npm packaged plugins, the name does not include the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"haraka-plugin"}]},{"type":"text","value":" prefix."}]},{"type":"element","tag":"h3","props":{"id":"register"},"children":[{"type":"text","value":"Register"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Register is the only plugin function that is syncronous and receives no arguments. Its primary purpose is enabling your plugin to register SMTP hooks. It is also used for syncronous initialization tasks such as "},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/haraka-config","rel":["nofollow"]},"children":[{"type":"text","value":"loading a config file"}]},{"type":"text","value":". For heavier initialization tasks such as establishing database connections, look to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"init_master"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"init_child"}]},{"type":"text","value":" instead."}]},{"type":"element","tag":"h3","props":{"id":"register-a-hook"},"children":[{"type":"text","value":"Register a Hook"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are two ways for plugins to register hooks. Both examples register a function on the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"rcpt"}]},{"type":"text","value":" hook:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"register_hook"}]},{"type":"text","value":" function in register():"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"exports.register = function() {\nthis.register_hook('rcpt', 'my_rcpt_validate');\n};"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"exports.my_rcpt_validate = function (next, connection, params) {\n// do processing\nnext();\n};"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The hook_"},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"$name"}]},{"type":"text","value":" syntax:"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"exports.hook_rcpt = function (next, connection, params) {\n// do processing\nnext();\n};"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The register_hook function within "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"register()"}]},{"type":"text","value":" offers a few advantages:"}]},{"type":"element","tag":"code","props":{"code":"1. register a hook multiple times (see below)\n2. a unique function name in stack traces\n3. [a better function name](https://google.com/search?q=programming%20good%20function%20names)\n4. hooks can be registered conditionally (ie, based on a config setting)\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"1. register a hook multiple times (see below)\n2. a unique function name in stack traces\n3. [a better function name](https://google.com/search?q=programming%20good%20function%20names)\n4. hooks can be registered conditionally (ie, based on a config setting)\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"register-a-hook-multiple-times"},"children":[{"type":"text","value":"Register a Hook Multiple Times"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To register the same hook more than once, call "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"register_hook()"}]},{"type":"text","value":" multiple times with the same hook name:"}]},{"type":"element","tag":"code","props":{"code":"exports.register = function() {\n    this.register_hook('queue', 'try_queue_my_way');\n    this.register_hook('queue', 'try_queue_highway');\n};\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"exports.register = function() {\n    this.register_hook('queue', 'try_queue_my_way');\n    this.register_hook('queue', 'try_queue_highway');\n};\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"try_queue_my_way()"}]},{"type":"text","value":" calls "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next()"}]},{"type":"text","value":", the next function registered on hook "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"queue"}]},{"type":"text","value":" will be called, in this case, "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"try_queue_highway()"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h4","props":{"id":"determine-hook-name"},"children":[{"type":"text","value":"Determine hook name"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When a single function runs on multiple hooks, the function can check the\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"hook"}]},{"type":"text","value":" property of the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"connection"}]},{"type":"text","value":" or "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"hmail"}]},{"type":"text","value":" argument to determine which hook it is running on:"}]},{"type":"element","tag":"code","props":{"code":"exports.register = function() {\n    this.register_hook('rcpt',    'my_rcpt');\n    this.register_hook('rcpt_ok', 'my_rcpt');\n};\n \nexports.my_rcpt = function (next, connection, params) {\n    var hook_name = connection.hook; // rcpt or rcpt_ok\n    // email address is in params[0]\n    // do processing\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"exports.register = function() {\n    this.register_hook('rcpt',    'my_rcpt');\n    this.register_hook('rcpt_ok', 'my_rcpt');\n};\n \nexports.my_rcpt = function (next, connection, params) {\n    var hook_name = connection.hook; // rcpt or rcpt_ok\n    // email address is in params[0]\n    // do processing\n}\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"next"},"children":[{"type":"text","value":"Next()"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"After registering a hook, functions are called with that hooks arguments (see "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Available Hooks"}]},{"type":"text","value":" below. The first argument is a callback function, conventionally named "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next"}]},{"type":"text","value":". When the function is completed, it calls "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next()"}]},{"type":"text","value":" and the connection continues. Failing to call "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next()"}]},{"type":"text","value":" will result in the connection hanging until that plugin's timer expires."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next([code, msg])"}]},{"type":"text","value":" accepts two optional parameters:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"code"}]},{"type":"text","value":" is one of the listed return codes."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"msg"}]},{"type":"text","value":" is a string to send to the client in case of a failure. Use an array to send a multi-line message. "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"msg"}]},{"type":"text","value":" should NOT contain the code number - that is handled by Haraka."}]}]},{"type":"element","tag":"h4","props":{"id":"next-return-codes"},"children":[{"type":"text","value":"Next() Return Codes"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These constants are in your plugin when it is loaded, you do not\nneed to define them:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CONT"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Continue and let other plugins handle this particular hook. This is the\ndefault. These are identical: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next()"}]},{"type":"text","value":" and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(CONT)"}]},{"type":"text","value":";"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DENY - Reject with a 5xx error."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DENYSOFT - Reject with a 4xx error."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DENYDISCONNECT - Reject with a 5xx error and immediately disconnect."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DISCONNECT - Immediately disconnect"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"OK"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Required by "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"rcpt"}]},{"type":"text","value":" plugins to accept a recipient and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"queue"}]},{"type":"text","value":" plugins when the queue was successful."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"After a plugin calls "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(OK)"}]},{"type":"text","value":", no further plugins on that hook will run."},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Exceptions to next(OK):"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"connect_init and disconnect hooks are "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"always called"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"On the deny hook, "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(OK)"}]},{"type":"text","value":" overrides the default CONT."}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"HOOK_NEXT"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"HOOK_NEXT is only available on the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"unrecognized_command"}]},{"type":"text","value":" hook. It instructs Haraka to run a different plugin hook. The "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"msg"}]},{"type":"text","value":" argument must be set to the name of the hook to be run. Ex: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(HOOK_NEXT, 'rcpt_ok');"}]}]}]},{"type":"element","tag":"h2","props":{"id":"available-hooks"},"children":[{"type":"text","value":"Available Hooks"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"These are the hook and their parameters (next excluded):"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"init_master - called when the main (master) process is started"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"init_child - in cluster, called when a child process is started"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"init_http - called when Haraka is started."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"init_wss - called after init_http"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"connect_init - used to init data structures, called for "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"every"}]},{"type":"text","value":" connection"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"lookup_rdns - called to look up the rDNS - return the rDNS via "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(OK, rdns)"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"connect - called after we got rDNS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"capabilities - called to get the ESMTP capabilities (such as STARTTLS)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"unrecognized_command - called when the remote end sends a command we don't recognise"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"disconnect - called upon disconnect"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"helo (hostname)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ehlo (hostname)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"quit"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"vrfy"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"noop"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"rset"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"mail ("},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"from, esmtp_params"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"rcpt ("},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"to,   esmtp_params"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"rcpt_ok (to)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"data - called at the DATA command"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"data_post - called at the end-of-data marker"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"max_data_exceeded - called when the message exceeds connection.max_bytes"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"queue - called to queue the mail"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"queue_outbound - called to queue the mail when connection.relaying is set"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"queue_ok - called when a mail has been queued successfully"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"reset_transaction - called before the transaction is reset (via RSET, or MAIL)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"deny - called when a plugin returns DENY, DENYSOFT or DENYDISCONNECT"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"get_mx (hmail, domain) - called by outbound to resolve the MX record"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"deferred (hmail, params) - called when an outbound message is deferred"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"bounce (hmail, err) - called when an outbound message bounces"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"delivered (hmail, "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"host, ip, response, delay, port, mode, ok_recips, secured, authenticated"}]},{"type":"text","value":") - called when outbound mail is delivered"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"send_email (hmail) - called when outbound is about to be sent"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"pre_send_trans_email (fake_connection) - called just before an email is queued to disk with a faked connection object"}]}]},{"type":"element","tag":"h3","props":{"id":"rcpt"},"children":[{"type":"text","value":"rcpt"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"rcpt"}]},{"type":"text","value":" hook is slightly special."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"connection.relaying == false"}]},{"type":"text","value":" (the default, to avoid being an open relay), a rcpt plugin MUST return "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(OK)"}]},{"type":"text","value":" or the sender will receive the error message \"I cannot deliver for that user\". The default "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"rcpt"}]},{"type":"text","value":" plugin  is "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"rcpt_to.in_host_list"}]},{"type":"text","value":", which lists the domains for which to accept email."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"After a "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"rcpt"}]},{"type":"text","value":" plugin calls "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(OK)"}]},{"type":"text","value":", the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"rcpt_ok"}]},{"type":"text","value":" hook is run."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If a plugin prior to the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"rcpt"}]},{"type":"text","value":" hook sets "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"connection.relaying = true"}]},{"type":"text","value":", then it is not necessary for a rcpt plugin to call "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(OK)"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"connect_init"},"children":[{"type":"text","value":"connect_init"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connect_init"}]},{"type":"text","value":" hook is unique in that all return codes are ignored. This is so that plugins that need to do initialization for every connection can be assured they will run. Return values are ignored."}]},{"type":"element","tag":"h3","props":{"id":"hook_init_http-next-server"},"children":[{"type":"text","value":"hook_init_http (next, Server)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If http listeners are are enabled in http.ini and the express module loaded, the express library will be located at Server.http.express. More importantly, the express "},{"type":"element","tag":"a","props":{"href":"http://expressjs.com/4x/api.html#app","rel":["nofollow"]},"children":[{"type":"text","value":"app / instance"}]},{"type":"text","value":" will be located at Server.http.app. Plugins can register routes on the app just as they would with any "},{"type":"element","tag":"a","props":{"href":"http://expressjs.com/","rel":["nofollow"]},"children":[{"type":"text","value":"Express.js"}]},{"type":"text","value":" app."}]},{"type":"element","tag":"h3","props":{"id":"hook_init_wss-next-server"},"children":[{"type":"text","value":"hook_init_wss (next, Server)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If express loaded, an attempt is made to load "},{"type":"element","tag":"a","props":{"href":"https://www.npmjs.com/package/ws","rel":["nofollow"]},"children":[{"type":"text","value":"ws"}]},{"type":"text","value":", the websocket server. If it succeeds, the wss server will be located at Server.http.wss. Because of how websockets work, only one websocket plugin will work at a time. One plugin using wss is "},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/haraka-plugin-watch","rel":["nofollow"]},"children":[{"type":"text","value":"watch"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"pre_send_trans_email-next-fake_connection"},"children":[{"type":"text","value":"pre_send_trans_email (next, fake_connection)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"fake"}]},{"type":"text","value":" connection here is a holder for a new transaction object. It only has the log methods and a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"transaction"}]},{"type":"text","value":" property\nso don't expect it to behave like a a real connection object. This hook is designed so you can add headers and modify mails\nsent via "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"outbound.send_email()"}]},{"type":"text","value":", see the dkim_sign plugin for an example."}]},{"type":"element","tag":"h2","props":{"id":"hook-order"},"children":[{"type":"text","value":"Hook Order"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The ordering of hooks is determined by the SMTP protocol. Knowledge of "},{"type":"element","tag":"a","props":{"href":"http://tools.ietf.org/html/rfc5321","rel":["nofollow"]},"children":[{"type":"text","value":"RFC 5321"}]},{"type":"text","value":" is beneficial."}]},{"type":"element","tag":"h5","props":{"id":"typical-inbound-connection"},"children":[{"type":"text","value":"Typical Inbound Connection"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_connect_init"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_lookup_rdns"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_connect"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_helo "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"OR"}]},{"type":"text","value":" hook_ehlo (EHLO is sent when ESMTP is desired which allows extensions\nsuch as STARTTLS, AUTH, SIZE etc.)"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_helo"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_ehlo"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_capabilities"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"hook_unrecognized_command"}]},{"type":"text","value":" is run for each ESMTP extension the client requests\ne.g. STARTTLS, AUTH etc.)"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_mail"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_rcpt (once per-recipient)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_rcpt_ok (for every recipient that hook_rcpt returned "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(OK)"}]},{"type":"text","value":" for)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_data"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"attachment hooks"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_data_post"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_queue "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"OR"}]},{"type":"text","value":" hook_queue_outbound"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_queue_ok (called if hook_queue or hook_queue_outbound returns "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next(OK)"}]},{"type":"text","value":")"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_quit "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"OR"}]},{"type":"text","value":" hook_rset "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"OR"}]},{"type":"text","value":" hook_helo "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"OR"}]},{"type":"text","value":" hook_ehlo (after a message has been sent or rejected, the client can disconnect or start a new transaction with RSET, EHLO or HELO)"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_reset_transaction"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_disconnect"}]}]},{"type":"element","tag":"h5","props":{"id":"typical-outbound-mail"},"children":[{"type":"text","value":"Typical Outbound mail"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By 'outbound' we mean messages using Haraka's built-in queue and delivery\nmechanism. The Outbound queue is used when "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connection.relaying = true"}]},{"type":"text","value":" is set during the  transaction and "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"hook_queue_outbound"}]},{"type":"text","value":" is called to queue the message."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The Outbound hook ordering mirrors the Inbound hook order above until after "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"hook_queue_outbound"}]},{"type":"text","value":", which is followed by:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_send_email"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_get_mx"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"at least one of:"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_delivered  (once per delivery domain with at least one successful recipient)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_deferred  (once per delivery domain where at least one recipient or connection was deferred)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hook_bounce  (once per delivery domain where the recipient(s) or message was rejected by the destination)"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"plugin-run-order"},"children":[{"type":"text","value":"Plugin Run Order"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plugins are run on each hook in the order that they are specified in "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config/plugins"}]},{"type":"text","value":". When a plugin returns anything other than "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"next()"}]},{"type":"text","value":" on a hook, all subsequent plugins due to run on that hook are skipped (exceptions: connect_init, disconnect)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is important as some plugins might rely on "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"results"}]},{"type":"text","value":" or "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"notes"}]},{"type":"text","value":" that have been set by plugins that need to run before them. This should be noted in the plugins documentation. Make sure to read it."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you are writing a complex plugin, you may have to split it into multiple plugins to run in a specific order e.g. you want hook_deny to run last after all other plugins and hook_lookup_rdns to run first, then you can explicitly register your hooks and provide a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"priority"}]},{"type":"text","value":" value which is an integer between -100 (highest priority) to 100 (lowest priority) which defaults to 0 (zero) if not supplied.  You can apply a priority to your hook in the following way:"}]},{"type":"element","tag":"code","props":{"code":"exports.register = function() {\n    var plugin = this;\n    plugin.register_hook('connect',  'hook_connect', -100);\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"exports.register = function() {\n    var plugin = this;\n    plugin.register_hook('connect',  'hook_connect', -100);\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This would ensure that your hook_connect function will run before any other\nplugins registered on the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connect"}]},{"type":"text","value":" hook, regardless of the order it was\nspecified in "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config/plugins"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Check the order that the plugins will run on each hook by running:"}]},{"type":"element","tag":"code","props":{"code":"haraka -o -c /path/to/config\n","language":"bash"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"haraka -o -c /path/to/config\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"skipping-plugins"},"children":[{"type":"text","value":"Skipping Plugins"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plugins can be skipped at runtime by pushing the name of the plugin into the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"skip_plugins"}]},{"type":"text","value":" array in "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"transaction.notes"}]},{"type":"text","value":".  This array is reset for every transaction and once a plugin is added to the list, it will not run any hooks in that plugin for the remainder of the transaction.  For example, one could create a whitelist plugin that skipped "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"spamassassin"}]},{"type":"text","value":" if the sender was in a whitelist."}]},{"type":"element","tag":"h2","props":{"id":"logging"},"children":[{"type":"text","value":"Logging"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plugins inherit all the logging methods of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"logger.js"}]},{"type":"text","value":", which are:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"logprotocol"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"logdebug"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"loginfo"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"lognotice"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"logwarn"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"logerror"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"logcrit"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"logalert"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"logemerg"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If plugins throw an exception when in a hook, the exception will be caught\nand generate a logcrit level error. However, exceptions will not be caught\nas gracefully when plugins are running async code. Use error codes for that,\nlog the error, and run your next() function appropriately."}]},{"type":"element","tag":"h2","props":{"id":"sharing-state"},"children":[{"type":"text","value":"Sharing State"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"There are several cases where you might need to share information between\nplugins.  This is done using "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"notes"}]},{"type":"text","value":" - there are three types available:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"server.notes"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Available in all plugins.  This is created at PID start-up and is shared\namongst all plugins on the same PID and listener.\nTypical uses for notes at this level would be to share database\nconnections between multiple plugins or connection pools etc."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"connection.notes"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Available on any hook that passes 'connection' as a function parameter.\nThis is shared amongst all plugins for a single connection and is\ndestroyed after the client disconnects.\nTypical uses for notes at this level would be to store information\nabout the connected client e.g. rDNS names, HELO/EHLO, white/black\nlist status etc."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"connection.transaction.notes"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Available on any hook that passes 'connection' as a function parameter\nbetween hook_mail and hook_data_post.\nThis is shared amongst all plugins for this transaction (e.g. MAIL FROM\nthrough until a message is received or the connection is reset).\nTypical uses for notes at this level would be to store information\non things like greylisting which uses client, sender and recipient\ninformation etc."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"hmail.todo.notes"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Available on any outbound hook that passes "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"hmail"}]},{"type":"text","value":" as a function parameter.\nThis is the same object as 'connection.transaction.notes', so anything\nyou store in the transaction notes is automatically available in the\noutbound functions here."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All of these notes are JS objects - use them as simple key/value store e.g."}]},{"type":"element","tag":"code","props":{"code":"connection.transaction.notes.test = 'testing';\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"connection.transaction.notes.test = 'testing';\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"plugins-as-modules"},"children":[{"type":"text","value":"Plugins as Modules"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plugins as NPM modules are named with the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"haraka-plugin"}]},{"type":"text","value":" prefix. Therefore, a\nplugin that frobnobricates might be called "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"haraka-plugin-frobnobricate"}]},{"type":"text","value":" and\npublished to NPM with that name. The prefix is not required in the\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config/plugins"}]},{"type":"text","value":" file."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plugins loaded as NPM modules behave slightly different than plugins loaded\nas plain JS files."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plain JS plugins have a custom "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"require()"}]},{"type":"text","value":" which allows loading core Haraka\nmodules via specifying "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"require('./name')"}]},{"type":"text","value":" (note the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"./"}]},{"type":"text","value":" prefix). Although\nthe core modules aren't in the same folder, the custom "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"require"}]},{"type":"text","value":" intercepts\nthis and look for core modules. Note that if there is a module in your plugins\nfolder of the same name that will not take preference, so avoid using names\nsimilar to core modules."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plugins loaded as modules do not have the special "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"require()"}]},{"type":"text","value":". To load\na core Haraka module you must use "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"this.haraka_require('name')"}]},{"type":"text","value":".\nThis should also be preferred for plain JS plugins, as the\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"./"}]},{"type":"text","value":" hack is likely to be removed in the future."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Plugins loaded as modules are not compiled in the Haraka plugin sandbox,\nwhich blocks access to certain globals and provides a global "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"server"}]},{"type":"text","value":" object.\nTo access the "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"server"}]},{"type":"text","value":" object, use "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connection.server"}]},{"type":"text","value":" instead."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Module plugins support default config in their local "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config"}]},{"type":"text","value":" directory. See the\n\"Default Config and Overrides\" section in "},{"type":"element","tag":"a","props":{"href":"Config"},"children":[{"type":"text","value":"Config"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"shutdown"},"children":[{"type":"text","value":"Shutdown"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"On graceful reload, Haraka will call a plugin's "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"shutdown"}]},{"type":"text","value":" method."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is so you can clear any timers or intervals, or shut down any connections\nto remote servers. See "},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/Haraka/issues/2024","rel":["nofollow"]},"children":[{"type":"text","value":"Issue 2024"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"e.g."}]},{"type":"element","tag":"code","props":{"code":"exports.shutdown = function () {\n    clearInterval(this._interval);\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"exports.shutdown = function () {\n    clearInterval(this._interval);\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you don't implement this in your plugin and have a connection open or a\ntimer running then Haraka will take 30 seconds to shut down and have to\nforcibly kill your process."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note: This only applies when running with a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"nodes=..."}]},{"type":"text","value":" value in smtp.ini."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"See also, "},{"type":"element","tag":"a","props":{"href":"Results"},"children":[{"type":"text","value":"Results"}]}]},{"type":"element","tag":"h2","props":{"id":"further-reading"},"children":[{"type":"text","value":"Further Reading"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Read about the "},{"type":"element","tag":"a","props":{"href":"Connection"},"children":[{"type":"text","value":"Connection"}]},{"type":"text","value":" object."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Outbound hooks are "},{"type":"element","tag":"a","props":{"href":"Outbound"},"children":[{"type":"text","value":"also documented"}]},{"type":"text","value":"."}]}]},"_type":"markdown","_id":"content:6.core:13.Plugins.md","_source":"content","_file":"6.core/13.Plugins.md","_extension":"md"},{"_path":"/core/Transaction","_dir":"core","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Transaction Object","description":"An SMTP transaction is valid from MAIL FROM time until RSET or \"final-dot\".","excerpt":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"transaction-object"},"children":[{"type":"text","value":"Transaction Object"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"An SMTP transaction is valid from MAIL FROM time until RSET or \"final-dot\"."}]},{"type":"element","tag":"h2","props":{"id":"api"},"children":[{"type":"text","value":"API"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.uuid"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A unique UUID for this transaction. Is equal to the connection.uuid + '.N'\nwhere N increments for each transaction on this connection."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.mail_from"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The value of the MAIL FROM command as an "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Address"}]},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":" object."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.rcpt_to"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"An Array of "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Address"}]},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":" objects of recipients from the RCPT TO command."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.message_stream"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A node.js Readable Stream object for the message."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You use it like this:"}]},{"type":"element","tag":"code","props":{"code":"transaction.message_stream.pipe(WritableStream, options)\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"transaction.message_stream.pipe(WritableStream, options)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Where WritableStream is a node.js Writable Stream object such as a\nnet.socket, fs.writableStream, process.stdout/stderr or custom stream."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The options argument should be an object that overrides the following\nproperties:"}]},{"type":"element","tag":"code","props":{"code":"    * line_endings (default: \"\\r\\n\")\n    * dot_stuffing (default: false)\n    * ending_dot   (default: false)\n    * end          (default: true)\n    * buffer_size  (default: 65535)\n    * clamd_style  (default: false)\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    * line_endings (default: \"\\r\\n\")\n    * dot_stuffing (default: false)\n    * ending_dot   (default: false)\n    * end          (default: true)\n    * buffer_size  (default: 65535)\n    * clamd_style  (default: false)\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"e.g."}]},{"type":"element","tag":"code","props":{"code":"transaction.message_stream.pipe(socket, { dot_stuffing: true, ending_dot: true });\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"transaction.message_stream.pipe(socket, { dot_stuffing: true, ending_dot: true });\n"}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.data_bytes"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The number of bytes in the email after DATA."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.add_data(line)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Adds a line of data to the email. Note this is RAW email - it isn't useful\nfor adding banners to the email."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.notes"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A safe place to store transaction specific values. See also "},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/haraka-results","rel":["nofollow"]},"children":[{"type":"text","value":"haraka-results"}]},{"type":"text","value":" and "},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/haraka-notes","rel":["nofollow"]},"children":[{"type":"text","value":"haraka-notes"}]},{"type":"text","value":"."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.add_leading_header(key, value)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Adds a header to the top of the header list.  This should only be used in\nvery specific cases.  Most people will want to use "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"add_header()"}]},{"type":"text","value":" instead."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.add_header(key, value)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Adds a header to the email."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.remove_header(key)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Deletes a header from the email."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.header"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The header of the email. See "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Header Object"}]},{"type":"text","value":"."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.parse_body = true|false "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"default: false"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Set to "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"true"}]},{"type":"text","value":" to enable parsing of the mail body. Make sure you set this in\nhook_data or before."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.body"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The body of the email if you set "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"parse_body"}]},{"type":"text","value":" above. See "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Body Object"}]},{"type":"text","value":"."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.attachment_hooks(start)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Sets a callback for when we see an attachment if "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"parse_body"}]},{"type":"text","value":" has been set."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"start"}]},{"type":"text","value":" event will receive "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"(content_type, filename, body, stream)"}]},{"type":"text","value":" as\nparameters."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The stream is a "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"ReadableStream"}]},{"type":"text","value":" - see "},{"type":"element","tag":"a","props":{"href":"http://nodejs.org/api/stream.html","rel":["nofollow"]},"children":[{"type":"text","value":"http://nodejs.org/api/stream.html"}]},{"type":"text","value":" for\ndetails on how this works."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you set stream.connection then the stream will apply backpressure to the\nconnection, allowing you to process attachments before the connection has\nended. Here is an example which stores attachments in temporary files using\nthe "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"tmp"}]},{"type":"text","value":" library from npm and tells us the size of the file:"}]},{"type":"element","tag":"code","props":{"code":"exports.hook_data = function (next, connection) {\n    // enable mail body parsing\n    connection.transaction.parse_body = true;\n    connection.transaction.attachment_hooks(\n        function (ct, fn, body, stream) {\n            start_att(connection, ct, fn, body, stream)\n        }\n    );\n    next();\n}\n\nfunction start_att (connection, ct, fn, body, stream) {\n    connection.loginfo(\"Got attachment: \" + ct + \", \" + fn + \" for user id: \" + connection.transaction.notes.hubdoc_user.email);\n    connection.transaction.notes.attachment_count++;\n\n    stream.connection = connection; // Allow backpressure\n    stream.pause();\n\n    var tmp = require('tmp');\n\n    tmp.file(function (err, path, fd) {\n        connection.loginfo(\"Got tempfile: \" + path + \" (\" + fd + \")\");\n        var ws = fs.createWriteStream(path);\n        stream.pipe(ws);\n        stream.resume();\n        ws.on('close', function () {\n            connection.loginfo(\"End of stream reached\");\n            fs.fstat(fd, function (err, stats) {\n                connection.loginfo(\"Got data of length: \" + stats.size);\n                // Close the tmp file descriptor\n                fs.close(fd, function(){});\n            });\n        });\n    });\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"exports.hook_data = function (next, connection) {\n    // enable mail body parsing\n    connection.transaction.parse_body = true;\n    connection.transaction.attachment_hooks(\n        function (ct, fn, body, stream) {\n            start_att(connection, ct, fn, body, stream)\n        }\n    );\n    next();\n}\n\nfunction start_att (connection, ct, fn, body, stream) {\n    connection.loginfo(\"Got attachment: \" + ct + \", \" + fn + \" for user id: \" + connection.transaction.notes.hubdoc_user.email);\n    connection.transaction.notes.attachment_count++;\n\n    stream.connection = connection; // Allow backpressure\n    stream.pause();\n\n    var tmp = require('tmp');\n\n    tmp.file(function (err, path, fd) {\n        connection.loginfo(\"Got tempfile: \" + path + \" (\" + fd + \")\");\n        var ws = fs.createWriteStream(path);\n        stream.pipe(ws);\n        stream.resume();\n        ws.on('close', function () {\n            connection.loginfo(\"End of stream reached\");\n            fs.fstat(fd, function (err, stats) {\n                connection.loginfo(\"Got data of length: \" + stats.size);\n                // Close the tmp file descriptor\n                fs.close(fd, function(){});\n            });\n        });\n    });\n}\n"}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.discard_data = true|false "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"default: false"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Set this flag to true to discard all data as it arrives and not store in\nmemory or on disk (in the message_stream property). You can still access\nthe attachments and body if you set parse_body to true. This is useful\nfor systems which do not need the full email, just the attachments or\nmail text."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.set_banner(text, html)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Sets a banner to be added to the end of the email. If the html part is not\ngiven (optional) then the text part will have each line ending replaced with\n"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"<br/>"}]},{"type":"text","value":" when being inserted into HTML parts."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.add_body_filter(ct_match, filter)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Adds a filter to be applied to body parts in the email.  ct_match should be a\nregular expression to match against the full content-type line, or a string to\nmatch at the start, e.g. "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"/^text\\/html/"}]},{"type":"text","value":" or "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"'text/plain'"}]},{"type":"text","value":".  filter will be\ncalled when each body part matching ct_match is complete.  It receives three\nparameters, the content-type line, the encoding name, and a buffer with the\nfull body part.  It should return a buffer with the desired contents of the\nbody in the same encoding."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"transaction.results"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Store results of processing in a structured format. See "},{"type":"element","tag":"a","props":{"href":"/core/Results"},"children":[{"type":"text","value":"docs/Results"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"1"}]},{"type":"text","value":": "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Address"}]},{"type":"text","value":" objects are address-rfc2821 objects. See "},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/node-address-rfc2821","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/haraka/node-address-rfc2821"}]}]}]},"_type":"markdown","_id":"content:6.core:15.Transaction.md","_source":"content","_file":"6.core/15.Transaction.md","_extension":"md"}]