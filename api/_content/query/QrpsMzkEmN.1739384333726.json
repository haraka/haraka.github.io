{"_path":"/plugins/greylist","_dir":"plugins","_draft":false,"_partial":false,"_locale":"","title":"Greylist - Greylisting plugin for Haraka","description":"Haraka greylist plugin - Delays delivery of mail from new senders","navigation":{"title":"greylist"},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"greylist-plugin"},"children":[{"type":"text","value":"greylist plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Basic greylisting plugin that follows common practices found on internets."}]},{"type":"element","tag":"h2","props":{"id":"principles-of-work"},"children":[{"type":"text","value":"Principles of work"}]},{"type":"element","tag":"h3","props":{"id":"notation"},"children":[{"type":"text","value":"Notation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The so-called "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"tuple"}]},{"type":"text","value":" consists of the following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"First subdomain of rDNS is stripped off (but no shorter than the domain boundary). This is considered a "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"hostid"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Envelope sender is the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"sender"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"RCPT TO would supply the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"recipient"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"hostid"}]},{"type":"text","value":" in above notation is chosen unless:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The connecting host has no PTR record, a.k.a. reverse DNS (rDNS). "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"gl"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The rDNS record contains the first two or last two octets of the IP address. "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"fcrdns"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The rDNS record contains the ‘short’, decimal, or hex representation of the full IP address. "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"fcrdns"}]},{"type":"text","value":" "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"gl"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Multiple rDNS records are returned. "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"gl"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The rDNS record cannot be verified by forward confirmation (e.g. FCrDNS). "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"fcrdns"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The top-level-domain (TLD) used is not valid. "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"gl"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In other cases, it's set to be the remote party's IP address."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We define the following time periods:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"black"}]},{"type":"text","value":":  between first connect and start of "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"gray"}]},{"type":"text","value":". Defer."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"gray"}]},{"type":"text","value":":   between "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"black"}]},{"type":"text","value":" and start of "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"white"}]},{"type":"text","value":". Allow. Host must re-try within this window."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"white"}]},{"type":"text","value":":  comes after "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"gray"}]},{"type":"text","value":". Allow up until the end of period, then let the record expire in case no connections were made."}]}]},{"type":"element","tag":"h3","props":{"id":"algorithm"},"children":[{"type":"text","value":"Algorithm"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The greylist algo is as following:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Party connects. All FcrDNS & DNSWL checks are run by earlier plugins."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Party sends "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"recipient"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"If not already whitelisted\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Check "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"tuple"}]},{"type":"text","value":" color (compare current TS against record creation TS)\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"black"}]},{"type":"text","value":"?\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create if no record exists. Defer."}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"gray"}]},{"type":"text","value":"?\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Allow. Promote record to "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"white"}]},{"type":"text","value":" status."}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"white"}]},{"type":"text","value":"?\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Allow. Update record TS."}]}]}]}]}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"In special case, "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"data"}]},{"type":"text","value":" hook runs above algo for all recipients. If any matched, all inherit the action."}]}]},{"type":"element","tag":"h3","props":{"id":"db-schema"},"children":[{"type":"text","value":"DB schema"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We store in Redis."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Key format for greylisting entries:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"grey:${hostid}:${sender}:${recipient} - grey record"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"white:${hostid} - white record"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"white"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"{ first_connect: TS, whitelisted: TS, updated: TS, lifetime: TTL, tried: Integer, tried_when_greylisted: Integer }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{ first_connect: TS, whitelisted: TS, updated: TS, lifetime: TTL, tried: Integer, tried_when_greylisted: Integer }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Where\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"first_connect"}]},{"type":"text","value":": TS of first connection (sender)\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"whitelisted"}]},{"type":"text","value":": basically the TS of this entry creation\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"updated"}]},{"type":"text","value":": last update TS\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"lifetime"}]},{"type":"text","value":": seconds for this entry to exist (== TTL)\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"tried"}]},{"type":"text","value":": number of checks against this entry\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"tried_when_greylisted"}]},{"type":"text","value":": number of checks while the host was +grey+ (sender)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"grey"}]},{"type":"text","value":":"}]},{"type":"element","tag":"pre","props":{"code":"{ created: TS, updated: TS, lifetime: TTL, tried: Integer }\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{ created: TS, updated: TS, lifetime: TTL, tried: Integer }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Where\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"created"}]},{"type":"text","value":": TS of first connection (copied to "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"first_connect"}]},{"type":"text","value":" of "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"white"}]},{"type":"text","value":" after promotion)\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"updated"}]},{"type":"text","value":": last update TS\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"lifetime"}]},{"type":"text","value":": seconds for this entry to exist (== TTL)\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"tried"}]},{"type":"text","value":": number of checks against this entry (copied to "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"tried_when_greylisted"}]},{"type":"text","value":" of "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"white"}]},{"type":"text","value":" after promotion)"}]},{"type":"element","tag":"h3","props":{"id":"whitelisting"},"children":[{"type":"text","value":"Whitelisting"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It's possible to whitelist hosts using the following section in greylist.ini config file:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ip_whitelist               IP or subnet (prefix notation)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"envelope_whitelist         MAIL FROM (email or domain)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"recipient_whitelist        RCPT TO  (email or domain)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"List of known dynamic hosts, to use the IP instead of the domain:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"special_dynamic_domains    Domain"}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"principles-of-work","depth":2,"text":"Principles of work","children":[{"id":"notation","depth":3,"text":"Notation"},{"id":"algorithm","depth":3,"text":"Algorithm"},{"id":"db-schema","depth":3,"text":"DB schema"},{"id":"whitelisting","depth":3,"text":"Whitelisting"}]}]}},"_type":"markdown","_id":"content:8.plugins:greylist.md","_source":"content","_file":"8.plugins/greylist.md","_stem":"8.plugins/greylist","_extension":"md"}