{"_path":"/plugins/connect.geoip","_dir":"plugins","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"geoip - GeoIP lookup","description":"Haraka geoip plugin - GeoIP lookup","navigation":{"title":"geoip"},"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"geoip-plugin"},"children":[{"type":"text","value":"geoip plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"provide geographic information about mail senders."}]},{"type":"element","tag":"h1","props":{"id":"synopsis"},"children":[{"type":"text","value":"SYNOPSIS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Use MaxMind's GeoIP databases to report geographic information about senders. This plugin has support for both the "},{"type":"element","tag":"a","props":{"href":"https://github.com/runk/node-maxmind","rel":["nofollow"]},"children":[{"type":"text","value":"maxmind"}]},{"type":"text","value":" and "},{"type":"element","tag":"a","props":{"href":"https://github.com/bluesmoon/node-geoip","rel":["nofollow"]},"children":[{"type":"text","value":"geoip-lite"}]},{"type":"text","value":" node modules."}]},{"type":"element","tag":"h1","props":{"id":"install"},"children":[{"type":"text","value":"INSTALL"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Install the npm geoip module you prefer:"}]},{"type":"element","tag":"code","props":{"code":"npm install maxmind\n  or\nnpm install -g geoip-lite\n","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"npm install maxmind\n  or\nnpm install -g geoip-lite"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If both are installed, maxmind will be preferred as it's faster and also provides ASN data. The maxmind module requires manual download of the GeoIP databases. The npm module "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"maxmind-geolite-mirror"}]},{"type":"text","value":" will download the files and keep them up-to-date if you run it periodically."}]},{"type":"element","tag":"code","props":{"code":"mkdir -p /usr/local/share/GeoIP\nnpm install -g maxmind-geolite-mirror\n/usr/local/bin/maxmind-geolite-mirror\n","language":"bash","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-944b27"},"children":[{"type":"text","value":"mkdir"}]},{"type":"element","tag":"span","props":{"class":"ct-5249b3"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-cbf744"},"children":[{"type":"text","value":"-p"}]},{"type":"element","tag":"span","props":{"class":"ct-5249b3"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-d382da"},"children":[{"type":"text","value":"/usr/local/share/GeoIP"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-944b27"},"children":[{"type":"text","value":"npm"}]},{"type":"element","tag":"span","props":{"class":"ct-5249b3"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-d382da"},"children":[{"type":"text","value":"install"}]},{"type":"element","tag":"span","props":{"class":"ct-5249b3"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-cbf744"},"children":[{"type":"text","value":"-g"}]},{"type":"element","tag":"span","props":{"class":"ct-5249b3"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-d382da"},"children":[{"type":"text","value":"maxmind-geolite-mirror"}]}]},{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{"class":"ct-944b27"},"children":[{"type":"text","value":"/usr/local/bin/maxmind-geolite-mirror"}]}]}]}]}]},{"type":"element","tag":"h1","props":{"id":"description"},"children":[{"type":"text","value":"DESCRIPTION"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"GeoIP results are stored in connection.notes.geoip and connection."},{"type":"element","tag":"a","props":{"href":"https://github.com/haraka/Haraka/blob/master/docs/Results.md","rel":["nofollow"]},"children":[{"type":"text","value":"results"}]},{"type":"text","value":" .connect.geoip. The following information is typically available:"}]},{"type":"element","tag":"code","props":{"code":"continent: NA,\ncountry:   US,\n","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"continent: NA,\ncountry:   US,"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If the GeoIP city database is available, the following may also be available:"}]},{"type":"element","tag":"code","props":{"code":"region:   CA,\ncity:     San Francisco,\nll:       [37.7484, -122.4156],\ndistance: 1539    // in kilometers\nrange:    [ 3479299040, 3479299071 ],\n","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"region:   CA,\ncity:     San Francisco,\nll:       [37.7484, -122.4156],\ndistance: 1539    // in kilometers\nrange:    [ 3479299040, 3479299071 ],"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"connect.geoip"}]},{"type":"text","value":" also adds entries like this to your logs:"}]},{"type":"element","tag":"code","props":{"code":"[connect.geoip] US\n[connect.geoip] US, WA\n[connect.geoip] US, WA, Seattle\n[connect.geoip] US, WA, Seattle, 1319km\n","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"[connect.geoip] US\n[connect.geoip] US, WA\n[connect.geoip] US, WA, Seattle\n[connect.geoip] US, WA, Seattle, 1319km"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Calculating the distance requires the public IP of this mail server. This may\nbe the IP that Haraka is bound to. If not, make sure that "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"utils.get_public_ip"}]},{"type":"text","value":"\ncan figure it out (via STUN or in "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"smtp.ini"}]},{"type":"text","value":")."}]},{"type":"element","tag":"h1","props":{"id":"config"},"children":[{"type":"text","value":"CONFIG"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"distance"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Perform the geodesic distance calculations. Calculates the distance \"as the\ncrow flies\" from the remote mail server."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This calculation requires a 'from' IP address. This will typically be the\npublic IP of your mail server. If Haraka is bound to a private IP, net_utils\nwill attempt to determine your public IP. If that doesn't work, edit\nconfig/smtp.ini and set "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"public_ip"}]},{"type":"text","value":"."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"show_city"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"show city data in logs and headers. City data is less accurate than country."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"show_region in logs and headers. Regional data are US states, Canadian\nprovinces and such."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Set a connection result to true if the distance exceeds this many kilometers."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"too_far=4000"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"asn"}]},{"type":"text","value":"report_as"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Permits reporting the ASN as another plugin (such as connect.asn)."}]},{"type":"element","tag":"h1","props":{"id":"spam-prediction-with-distance"},"children":[{"type":"text","value":"SPAM PREDICTION WITH DISTANCE"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://www.cc.gatech.edu/~feamster/papers/snare-usenix09.pdf","rel":["nofollow"]},"children":[{"type":"text","value":"Spatio-temporal Network-level Automatic Reputation Engine"}]}]},{"type":"element","tag":"code","props":{"code":"\"For ham, 90% of the messages travel about 4,000 km or less. On the\nother hand, for spam, only 28% of messages stay within this range.\"\n","meta":null},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"div","props":{"class":"line"},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\"For ham, 90% of the messages travel about 4,000 km or less. On the\nother hand, for spam, only 28% of messages stay within this range.\""}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Observations in 2014 suggest that geodesic distance continues to be an\nexcellent predictor of spam."}]},{"type":"element","tag":"h1","props":{"id":"limitations"},"children":[{"type":"text","value":"LIMITATIONS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The distance calculations are more concerned with being fast than\naccurate. The MaxMind location data is collected from whois and is of\nlimited accuracy. MaxMind offers more accurate data for a fee."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For distance calculations, the earth is considered a perfect sphere. In\nreality, it is not. Accuracy should be within 1%."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This plugin does not update the GeoIP databases. You may want to."}]},{"type":"element","tag":"h1","props":{"id":"see-also"},"children":[{"type":"text","value":"SEE ALSO"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"MaxMind: "},{"type":"element","tag":"a","props":{"href":"http://www.maxmind.com/","rel":["nofollow"]},"children":[{"type":"text","value":"http://www.maxmind.com/"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Databases: "},{"type":"element","tag":"a","props":{"href":"https://dev.maxmind.com/geoip/geolite2-free-geolocation-data","rel":["nofollow"]},"children":[{"type":"text","value":"https://dev.maxmind.com/geoip/geolite2-free-geolocation-data"}]}]},{"type":"element","tag":"h1","props":{"id":"todo"},"children":[{"type":"text","value":"TODO"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Keep an eye on node-geoip and see if they add ASN support. This would be an\nalternative to connect.asn which uses a DNS lookup to retrieve the ASN."}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-d382da{color:#0A3069}\n.ct-cbf744{color:#0550AE}\n.ct-5249b3{color:#24292F}\n.ct-944b27{color:#953800}\n.dark .ct-944b27{color:#FFA657}\n.dark .ct-5249b3{color:#C9D1D9}\n.dark .ct-cbf744{color:#79C0FF}\n.dark .ct-d382da{color:#A5D6FF}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:8.plugins:connect.geoip.md","_source":"content","_file":"8.plugins/connect.geoip.md","_extension":"md"}